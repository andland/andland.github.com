
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Statistically Significant</title>
  <meta name="author" content="Andrew Landgraf">

  
  <meta name="description" content="A lot of times we are given a data set in Excel format and we want to run a quick analysis using R&#8217;s functionality to look at advanced &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://andland.github.io/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Statistically Significant" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Statistically Significant</a></h1>
  
    <h2>Andrew Landgraf's Blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:andland.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Blog Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/projects">Shiny</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/24/copying-data-from-excel-to-r-and-back_24/">Copying Data From Excel to R and Back</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-24T00:00:00-05:00" pubdate data-updated="true">Feb 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
A lot of times we are given a data set in Excel format and we want to run a quick analysis using R&#8217;s functionality to look at advanced statistics or make better visualizations. There are packages for importing/exporting data from/to Excel, but I have found them to be hard to work with or only work with old versions of Excel (*.xls, not *.xlsx). So for a one time analysis, I usually save the file as a csv and import it into R.<br /><br />This can be a little burdensome if you are trying to do something quick and creates a file that needs to be cleaned up later. An easier option is to copy and paste the data directly into R. This can be done by using &#8220;clipboard&#8221; as the file and specifying that it is tab delimited, since that is how Excel&#8217;s clipboard stores the data.<br /><br />For example, say you have a table in excel you want to copy into R. First, copy it in Excel.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-qPkCaCo_zWw/USpK8GLtKsI/AAAAAAAAHq0/9LrZwb05LVg/s1600/Capture.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-qPkCaCo_zWw/USpK8GLtKsI/AAAAAAAAHq0/9LrZwb05LVg/s1600/Capture.PNG" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />Then go into R and use this function.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">read.excel &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>header=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #339933;">,</span>...<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <a href="http://inside-r.org/r-doc/utils/read.table"><span style="color: #003399; font-weight: bold;">read.table</span></a><span style="color: #009900;">(</span><span style="color: blue;">"clipboard"</span><span style="color: #339933;">,</span>sep=<span style="color: blue;">"<span style="color: #000099; font-weight: bold;">\t</span>"</span><span style="color: #339933;">,</span>header=header<span style="color: #339933;">,</span>...<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />dat=read.excel<span style="color: #009900;">(</span><span style="color: #009900;">)</span></pre></div></div><br />This function specifies that you are reading data from the clipboard, that it is tab delimited, and that it has a header.<br /><br />Similarly, you can copy from R to Excel using the same logic. Here I also make <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">row.name=FALSE</span> as default since I rarely have meaningful row names and they mess up the header alignment.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">write.excel &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/row.names"><span style="color: #003399; font-weight: bold;">row.names</span></a>=<span style="color: black; font-weight: bold;">FALSE</span><span style="color: #339933;">,</span>col.names=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #339933;">,</span>...<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <a href="http://inside-r.org/r-doc/utils/write.table"><span style="color: #003399; font-weight: bold;">write.table</span></a><span style="color: #009900;">(</span>x<span style="color: #339933;">,</span><span style="color: blue;">"clipboard"</span><span style="color: #339933;">,</span>sep=<span style="color: blue;">"<span style="color: #000099; font-weight: bold;">\t</span>"</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/row.names"><span style="color: #003399; font-weight: bold;">row.names</span></a>=<a href="http://inside-r.org/r-doc/base/row.names"><span style="color: #003399; font-weight: bold;">row.names</span></a><span style="color: #339933;">,</span>col.names=col.names<span style="color: #339933;">,</span>...<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />write.excel<span style="color: #009900;">(</span>dat<span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br />These functions can be added to you .RProfile so that they are always ready for a quick analysis!<br /><br />Obviously, this technique does not encourage reproducible research. It is meant to be used for quick, ad hoc analysis and plotting; not something you would use for an analysis that needs to be done on a regular basis.<br /><br /></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Justin Tapp</div>
<div class='content'>
I&#39;m using this function in R for Windows. When I view the data numerically, it&#39;s fine. But when I go to plot the data I get nonsense. How to describe it&#8230;the window has 0 to 250 on the x-axis (regardless of my data series) and white boxes across the middle. </div>
</div>
<div class='comment'>
<div class='author'>Marek Sz</div>
<div class='content'>
I create similar functions and got few tips. For reading from excel following settings can be useful:<br />na.strings = &quot;&quot; # to prevent replacing NA string to missing value<br />comment.char = &quot;&quot; # to not loose everything after # sign<br />quote = &quot;&quot; # or &#39; or &quot; could mess with data<br />check.names = FALSE # if you want column names as in excel (spaces, special characters, etc.). You need to use `column name` in R to reference such columns.<br /><br />For writing na=&quot;&quot; replace missing values by empty string and not &quot;NA&quot; as on default.<br /><br />Second thing is that you can increase size of clipboard by using e.g. &quot;clipboard-10240&quot; instead of &quot;clipboard&quot; (it&#39;s a size in Kb, so it&#39;s around 10Mb; see help for connection, section Clipboard) which allow to copy and paste larger tables.</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
rkward (http://rkward.sourceforge.net/) has a very nifty feature (Edit -&gt; Paste Special&#8230;), that allows you to paste the copied data directly into your R source code, already formatted as a single string, vector or matrix. </div>
</div>
<div class='comment'>
<div class='author'>William Yarberry</div>
<div class='content'>
Excellent article.  Real people are always busy and this is just the kind of article that helps us all.  I have been doing scan() but when you start entering a few thousand rows that way, it gets a bit slow.  </div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
scan() allows you to just paste&#8230;<br /><br />y &lt;- scan()</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Thank you for these!!<br /></div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Thank you for the tip, this will help me a lot.<br />Also, it seems that, libreOffice also uses clipboard to store copied things. This function also works for libreOffice</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
I can&#39;t resist: you could just use<br />read.delim(&quot;clipboard&quot;)<br /><br />(The &quot;clipboard&quot; parameter is &#39;doze only for the foreseeable future)<br /><br />From &quot;?read.delim&quot;<br />read.delim(file, header = TRUE, sep = &quot;\t&quot;, quote=&quot;\&quot;&quot;, dec=&quot;.&quot;,<br />           fill = TRUE, comment.char=&quot;&quot;, &#8230;)</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Thank you very much Tony for your quick answer (on a  Sunday afternoon!!). <br /><br />Ernesto</div>
</div>
<div class='comment'>
<div class='author'>Tony Hirst</div>
<div class='content'>
@Ernesto It seems that on a Mac, you can use pbpaste ( http://stackoverflow.com/questions/9035674/r-function-to-copy-to-clipboard-on-mac-osx )<br /><br />read.clipboard.mac &lt;- function(header=TRUE,&#8230;) {<br />  read.table(pipe(&quot;pbpaste&quot;),sep=&quot;\t&quot;,header=header,&#8230;)<br />}<br /> </div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Thank you very much. Very useful. I work in both Windows and Mac Environments. The trick you show seems to work only in Windows. Any idea what to do in Mac? Thanks in advance,<br /><br />Ernesto</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/23/text-decryption-using-mcmc/">Text Decryption Using MCMC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-23T00:00:00-05:00" pubdate data-updated="true">Jan 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
The famous probabilist and statistician Persi Diaconis wrote an article not too long ago about the &#8221;<a href="http://math.uchicago.edu/~shmuel/Network-course-readings/MCMCRev.pdf" target="_blank">Markov chain Monte Carlo (MCMC) Revolution</a>.&#8221; The paper describes how we are able to solve a diverse set of problems with MCMC. The first example he gives is a text decryption problem solved with a simple Metropolis Hastings sampler.<br /><br />I was always stumped by those <a href="https://en.wikipedia.org/wiki/Cryptogram" target="_blank">cryptograms</a> in the newspaper and thought it would be pretty cool if I could crack them with statistics. So I decided to try it out on my own. The example Diaconis gives is fleshed out in more details by its original authors in its own <a href="http://probability.ca/jeff/ftpdir/decipherart.pdf" target="_blank">article</a>. <br /><br />The decryption I will be attempting is called <a href="https://en.wikipedia.org/wiki/Substitution_cipher" target="_blank">substitution cipher</a>, where each letter of the alphabet corresponds to another letter (possibly the same one). This is the rule that you must follow for the cryptogram game too. There are 26! = 4e26 possible mappings of the letters of the alphabet to one another. This seems like a hopeless problem to solve, but I will show you that a relatively simple solution can be found as long as your reference text is large enough and the text you are trying to decipher is also large enough.<br /><br />The strategy is to use a reference text to create transition probabilities from each letter to the next. This can be stored in a 26 by 26 matrix, where the ith row and jth column is the probability of the jth letter, given the ith letter preceded it. For example, the given the previous letter was a Q, U almost always follows it, so the Q-row and U-column would be close to probability of 1. Assuming these one step transition probabilities are what matter, the likelihood of any mapping is the product of the transition probabilities observed.<br /><br />To create a transition matrix, I downloaded <i>War and Peace </i>from <a href="http://www.gutenberg.org/dirs/2/6/0/2600/2600.txt" target="_blank">Project Gutenberg</a>. I looped through each letter and kept track of the number of number of times each letter followed the previous. I also kept track of a 27th character, which was anything that was not a letter &#8211; for example periods, commas, spaces, etc. This lets me know which letters are more likely to start a word or end a word. Consecutive entries of these special characters are not considered.<br /><br />After I have these counts, I normalize by dividing by the row total. Before normalizing, I add 1 to each cell so that there are no probabilities of 0. This also corresponds to prior information of each transition being equally likely. I could have tried to give more informative prior information (like Q to U being likely), but it would have been difficult and probably inaccurate for the whole matrix.<br /><br />Below is the code for creating the transition probability matrix. Note that I loop through each line and within each line I loop through each character.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">reference=<a href="http://inside-r.org/r-doc/base/readLines"><span style="color: #003399; font-weight: bold;">readLines</span></a><span style="color: #009900;">(</span><span style="color: blue;">"warandpeace.txt"</span><span style="color: #009900;">)</span><br />reference=<a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">)</span><br />&nbsp;<br />trans.mat=<a href="http://inside-r.org/r-doc/base/matrix"><span style="color: #003399; font-weight: bold;">matrix</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><span style="color: blue;">""</span><span style="color: #009900;">)</span><br />lastletter=<span style="color: blue;">""</span><br /><span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>ln <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/length"><span style="color: #003399; font-weight: bold;">length</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>ln %% <span style="color: #cc66cc;">1000</span> ==<span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><a href="http://inside-r.org/r-doc/base/cat"><span style="color: #003399; font-weight: bold;">cat</span></a><span style="color: #009900;">(</span><span style="color: blue;">"Line"</span><span style="color: #339933;">,</span>ln<span style="color: #339933;">,</span><span style="color: blue;">"<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #009900;">}</span><br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>pos <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/nchar"><span style="color: #003399; font-weight: bold;">nchar</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">[</span>ln<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    curletter=<a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">[</span>ln<span style="color: #009900;">]</span><span style="color: #339933;">,</span>pos<span style="color: #339933;">,</span>pos<span style="color: #009900;">)</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>curletter %in% <a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><br />                <a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==curletter<span style="color: #009900;">]</span>=<br />        trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><br />                  <a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==curletter<span style="color: #009900;">]</span>+<span style="color: #cc66cc;">1</span><br />      lastletter=curletter<br />    <span style="color: #009900;">}</span> <span style="color: black; font-weight: bold;">else</span> <span style="color: #009900;">{</span><br />      <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />        trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>=<br />          trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>+<span style="color: #cc66cc;">1</span><br />        lastletter=<span style="color: blue;">""</span><br />      <span style="color: #009900;">}</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br />  curletter=<span style="color: blue;">""</span><br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>=<br />      trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>+<span style="color: #cc66cc;">1</span><br />  <span style="color: #009900;">}</span><br />  lastletter=<span style="color: blue;">""</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />trans.prob.mat=<a href="http://inside-r.org/r-doc/base/sweep"><span style="color: #003399; font-weight: bold;">sweep</span></a><span style="color: #009900;">(</span>trans.mat+<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/rowSums"><span style="color: #003399; font-weight: bold;">rowSums</span></a><span style="color: #009900;">(</span>trans.mat+<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>FUN=<span style="color: blue;">"/"</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><br />I like to visualize my data to make sure everything looks correct. Below is a plot of the transition matrix.&nbsp; The blank space corresponds to non-letter character. A lot of insights can be garnered from this plot. The Q-U relationship pops out. T is the most likely letter to start a word. E is a popular letter to follow many others. Y is likely to end a word.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>melt<span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">)</span><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>Var2<span style="color: #339933;">,</span>Var1<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+geom_tile<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>fill=value<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  scale_fill_gradient<span style="color: #009900;">(</span>low=<span style="color: blue;">"white"</span><span style="color: #339933;">,</span>high=<span style="color: blue;">"black"</span><span style="color: #339933;">,</span>limits=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  labs<span style="color: #009900;">(</span>x=<span style="color: blue;">"Probability of Second Letter"</span><span style="color: #339933;">,</span>y=<span style="color: blue;">"Conditioning on First Letter"</span><span style="color: #339933;">,</span>fill=<span style="color: blue;">"Prob"</span><span style="color: #009900;">)</span>+<br />  scale_y_discrete<span style="color: #009900;">(</span>limits = <a href="http://inside-r.org/r-doc/base/rev"><span style="color: #003399; font-weight: bold;">rev</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/levels"><span style="color: #003399; font-weight: bold;">levels</span></a><span style="color: #009900;">(</span>melt<span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">)</span>$Var1<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  coord_equal<span style="color: #009900;">(</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-rOSjww2Z0q0/UPlrNU1mO2I/AAAAAAAAHqM/NizWxWZ8K88/s1600/trans.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://lh3.ggpht.com/-rOSjww2Z0q0/UPlrNU1mO2I/AAAAAAAAHqM/NizWxWZ8K88/s1600/trans.jpeg" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />The desired solution will be the one that gives the highest likelihood. This is an <a href="https://en.wikipedia.org/wiki/NP-hard" target="_blank">NP-hard</a> problem so the only way to find the solution is to try all 26! combinations of mappings, which is infeasible, and report the one with the highest likelihood.<br /><br />With the MCMC approach you start with a random mapping of letters. Next you propose a new mapping by randomly switching 2 of the characters in the mapping. So if A mapped to G and L mapped to Z and you switched those two, A would map to Z and L would map to G. With this new mapping, you measure the likelihood and divide it by the likelihood of the previous mapping. If this ratio is greater than 1, then move to this new mapping. If the ratio is less than 1, meaning the new mapping is less likely, then move to this new mapping with a probability equal to the ratio. (Practically, this is done by drawing a random uniform number between 0 and 1 and moving to the proposed mapping if the uniform number is less than the ratio.) Repeat this process until you think you have found a solution.<br /><br />To do this, I first wrote a few functions. One to decode the coded text based on the mapping. The other was to calculate the log likelihood of the decoded text.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">decode &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>coded<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  coded=<a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span>coded<span style="color: #009900;">)</span><br />  decoded=coded<br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>i <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/nchar"><span style="color: #003399; font-weight: bold;">nchar</span></a><span style="color: #009900;">(</span>coded<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>coded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span> %in% <a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      <a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>decoded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">[</span>mapping==<a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>coded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br />  decoded<br /><span style="color: #009900;">}</span><br />&nbsp;<br />&nbsp;<br />log.prob &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>decoded<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  logprob=<span style="color: #cc66cc;">0</span><br />&nbsp;<br />  lastletter=<span style="color: blue;">""</span><br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>i <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/nchar"><span style="color: #003399; font-weight: bold;">nchar</span></a><span style="color: #009900;">(</span>decoded<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    curletter=<a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>decoded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>curletter %in% <a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      logprob=logprob+<a href="http://inside-r.org/r-doc/base/log"><span style="color: #003399; font-weight: bold;">log</span></a><span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><br />                                         <a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==curletter<span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />      lastletter=curletter<br />    <span style="color: #009900;">}</span> <span style="color: black; font-weight: bold;">else</span> <span style="color: #009900;">{</span><br />      <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />        logprob=logprob+<a href="http://inside-r.org/r-doc/base/log"><span style="color: #003399; font-weight: bold;">log</span></a><span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />        lastletter=<span style="color: blue;">""</span><br />      <span style="color: #009900;">}</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br />&nbsp;<br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    logprob=logprob+<a href="http://inside-r.org/r-doc/base/log"><span style="color: #003399; font-weight: bold;">log</span></a><span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />    lastletter=<span style="color: blue;">""</span><br />  <span style="color: #009900;">}</span><br />  logprob<br /><span style="color: #009900;">}</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br />To show how this works, I will use the same Shakespeare text that is used in the MCMC Revolution paper. I let it run until it tries out 2000 different mappings (not the same as 2000 iterations, because rejected proposals are not counted). Along the way I am keeping track of the most likely mapping visited, and that will be the final estimate. It should be noted that I am only considering the mapping of letters and it is assumed that the special characters are known. For example spaces and periods are assumed to be the same.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">correctTxt=<span style="color: blue;">"ENTER HAMLET HAM TO BE OR NOT TO BE THAT IS THE QUESTION WHETHER TIS NOBLER IN THE MIND TO SUFFER THE SLINGS AND ARROWS OF OUTRAGEOUS FORTUNE OR TO TAKE ARMS AGAINST A SEA OF TROUBLES AND BY OPPOSING END"</span><br />coded=decode<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399; font-weight: bold;">sample</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>correctTxt<span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># randomly scramble the text</span><br />&nbsp;<br />mapping=<a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399; font-weight: bold;">sample</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># initialize a random mapping</span><br />i=<span style="color: #cc66cc;">1</span><br />iters=<span style="color: #cc66cc;">2000</span><br />cur.decode=decode<span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>coded<span style="color: #009900;">)</span><br />cur.loglike=log.prob<span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>cur.decode<span style="color: #009900;">)</span><br />max.loglike=cur.loglike<br />max.decode=cur.decode<br /><span style="color: black; font-weight: bold;">while</span> <span style="color: #009900;">(</span>i&lt;=iters<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  proposal=<a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399; font-weight: bold;">sample</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">26</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># select 2 letters to switch</span><br />  prop.mapping=mapping<br />  prop.mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span>=mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><br />  prop.mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span>=mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><br />&nbsp;<br />  prop.decode=decode<span style="color: #009900;">(</span>prop.mapping<span style="color: #339933;">,</span>coded<span style="color: #009900;">)</span><br />  prop.loglike=log.prob<span style="color: #009900;">(</span>prop.mapping<span style="color: #339933;">,</span>prop.decode<span style="color: #009900;">)</span><br />&nbsp;<br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/runif"><span style="color: #003399; font-weight: bold;">runif</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span>&lt;exp<span style="color: #009900;">(</span>prop.loglike-cur.loglike<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    mapping=prop.mapping<br />    cur.decode=prop.decode<br />    cur.loglike=prop.loglike<br />&nbsp;<br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>cur.loglike&gt;max.loglike<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      max.loglike=cur.loglike<br />      max.decode=cur.decode<br />    <span style="color: #009900;">}</span><br />&nbsp;<br />    <a href="http://inside-r.org/r-doc/base/cat"><span style="color: #003399; font-weight: bold;">cat</span></a><span style="color: #009900;">(</span>i<span style="color: #339933;">,</span>cur.decode<span style="color: #339933;">,</span><span style="color: blue;">"<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><br />    i=i+<span style="color: #cc66cc;">1</span><br />  <span style="color: #009900;">}</span><br /><span style="color: #009900;">}</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><br />The output of this example is below. You can see that it comes close but it doesn&#8217;t quite find the correct mapping. I attribute this to the fact that the text I was trying to decode only had 203 characters. In the paper mentioned above, they decoded the whole play. They further say that their methods work just as well if you randomly sample a text snippet 2000 characters long. Obviously my example had well less than this. This is also a problem in trying to solve a cryptogram because those are even smaller than the Hamlet example I used. So unfortunately this simple method cannot be used for that. (Note that I ran the MCMC chain a several times, using different random starting points, until it came reasonably close to the solution. This is something that the authors also suggested doing.)<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-DABUm0zHOa4/UPmFEVqbsWI/AAAAAAAAHqc/UgIi3nx4VTk/s1600/Iters.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://lh3.ggpht.com/-DABUm0zHOa4/UPmFEVqbsWI/AAAAAAAAHqc/UgIi3nx4VTk/s1600/Iters.png" /></a></div><br /><br />I want to also note that I originally used Alice and Wonderland as the reference text. It had more trouble decoding since this book is much smaller than War and Peace, and therefore the transition probabilities were not as good.<br /><br />The MCMC method is a greedy approach in that you are moving to any mapping that increases the likelihood. Greedy methods are not optimal in general because they can get stuck at local modes, especially in high dimensional problems. MCMC avoids this be moving to less likely mappings with some probability, which ensures that it will find the correct solution with enough time.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Vivek</div>
<div class='content'>
Andrew,<br /><br />This work is cool!<br /><br />I wrote my own substitution cipher decoder using the algorithm described in Stephen Connor&#39;s dissertation as the basis, but I occasionally glanced at your work as well.<br /><br />My code doesn&#39;t work as awesomely as yours, and it is also much slower (possibly because I use 76 versus the 27 characters, reachChar versus readLine), and I use different functions.<br /><br />But I cited your work and copied your idea for the melt matrix, which is ingenious.<br /><br />Thanks so much!<br /><br />Vivek</div>
</div>
<div class='comment'>
<div class='author'>Andrew Landgraf</div>
<div class='content'>
Thanks, Fernando. I knew I could speed it up by treating it as a vector of letters (or integers), but didn&#39;t take the time to figure it out.</div>
</div>
<div class='comment'>
<div class='author'>Fernando</div>
<div class='content'>
Nice work, but the code to get the transition matrix is VERY slow. I manage to make it faster doing the following:<br />1- get the vector of words (using scan() for example).<br />2- For each word, use strsplit(word, NULL)[[1]] and iterate<br />over the characters to populate the matrix.</div>
</div>
<div class='comment'>
<div class='author'>Andrew</div>
<div class='content'>
I have had that issue working on different computers. I think older versions of reshape2 use X# and newer versions use Var#. Or maybe it&#39;s a difference between using the package reshape and reshape2?</div>
</div>
<div class='comment'>
<div class='author'>Pablik</div>
<div class='content'>
Great work! Sometimes I use Persi&#39;s example for teaching MCMC,<br />there are some old matlab code from the original consultancy work,<br />but I never tryed to replicate the example.<br /><br />I got an error at:<br />ggplot(melt(trans.prob.mat),aes(Var2,Var1))+&#8230;<br /><br />the melt() function uses X1 and X2:<br />&gt; tmp &lt;- melt(trans.prob.mat)<br />&gt; head(tmp)<br />  X1 X2        value<br />1  A  A 3.893588e-05<br />2  B  A 9.252956e-02<br />&#8230;<br />Cheers,<br /><br />Pablo<br /></div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/14/restricted-boltzmann-machines-in-r/">Restricted Boltzmann Machines in R</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-14T00:00:00-05:00" pubdate data-updated="true">Jan 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<a href="http://en.wikipedia.org/wiki/Boltzmann_machine#Restricted_Boltzmann_machine">Restricted Boltzmann Machines</a> (RBMs) are an unsupervised learning method (like principal components).  An RBM is a probabilistic and undirected graphical model. They are  becoming more popular in machine learning due to recent success in  training them with <a href="http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k">contrastive divergence</a>. They have been proven useful in collaborative filtering, being one of the most successful methods in the Netflix challenge (<a href="http://www.machinelearning.org/proceedings/icml2007/papers/407.pdf">paper</a>). Furthermore, they have been tantamount to training <a href="http://www.nytimes.com/2012/11/24/science/scientists-see-advances-in-deep-learning-a-part-of-artificial-intelligence.html">deep learning</a> models, which appear to be the best current models for image and digit recognition.<br /><br />I do not want to go into too much detail, but I would like to give a high level overview of RBMs. <a href="http://blog.echen.me/2011/07/18/introduction-to-restricted-boltzmann-machines/">Edwin Chen</a> has an introduction that is much better. The usual version of an RBM is  a probabilistic model for binary vectors. An image can be represented  as a binary vector if each pixel that is dark enough is represented as a  1 and the non-dark pixels are 0&#8217;s. In addition to the visible binary  vector, it is assumed that there is a hidden binary vector, and each  element of the hidden unit is connected to each unit of the visible unit  by symmetric weights. The weights are represented by the matrix <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-1"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 1.042em;"><span style="clip: rect(1.775em, 1000em, 2.897em, -0.574em); left: 0em; position: absolute; top: -2.667em;"><span class="mrow" id="MathJax-Span-2"><span class="mi" id="MathJax-Span-3" style="font-family: MathJax_Math; font-style: italic;">W<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.104em;"></span></span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 1.013em; overflow: hidden; vertical-align: -0.11em; width: 0px;"></span></span></nobr></span>, where the <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-2-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-4"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 1.944em;"><span style="clip: rect(1.719em, 1000em, 3.218em, -0.604em); left: 0em; position: absolute; top: -2.806em;"><span class="mrow" id="MathJax-Span-5"><span class="mi" id="MathJax-Span-6" style="font-family: MathJax_Math; font-style: italic;">i</span><span class="mo" id="MathJax-Span-7" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-8" style="padding-left: 0.167em;"><span style="display: inline-block; height: 0px; position: relative; width: 1.186em;"><span style="clip: rect(1.797em, 1000em, 3.079em, -0.637em); left: 0em; position: absolute; top: -2.667em;"><span class="mi" id="MathJax-Span-9" style="font-family: MathJax_Math; font-style: italic;">j</span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span><span style="left: 0.417em; position: absolute; top: -2.569em;"><span class="texatom" id="MathJax-Span-10"><span class="mrow" id="MathJax-Span-11"><span class="mi" id="MathJax-Span-12" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">t</span><span class="mi" id="MathJax-Span-13" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">h</span></span></span><span style="display: inline-block; height: 2.181em; width: 0px;"></span></span></span></span></span><span style="display: inline-block; height: 2.806em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 1.466em; overflow: hidden; vertical-align: -0.328em; width: 0px;"></span></span></nobr></span> component is the weight between hidden unit <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-3-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-14"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 0.347em;"><span style="clip: rect(1.797em, 1000em, 2.886em, -0.604em); left: 0em; position: absolute; top: -2.667em;"><span class="mrow" id="MathJax-Span-15"><span class="mi" id="MathJax-Span-16" style="font-family: MathJax_Math; font-style: italic;">i</span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 0.973em; overflow: hidden; vertical-align: -0.097em; width: 0px;"></span></span></nobr></span> and visible unit <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-4-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-17"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 0.417em;"><span style="clip: rect(1.797em, 1000em, 3.079em, -0.637em); left: 0em; position: absolute; top: -2.667em;"><span class="mrow" id="MathJax-Span-18"><span class="mi" id="MathJax-Span-19" style="font-family: MathJax_Math; font-style: italic;">j</span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 1.205em; overflow: hidden; vertical-align: -0.328em; width: 0px;"></span></span></nobr></span>.  It is important that there are no connections between hidden units or  between visible units. The probability that visible unit <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-5-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-20"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 0.417em;"><span style="clip: rect(1.797em, 1000em, 3.079em, -0.637em); left: 0em; position: absolute; top: -2.667em;"><span class="mrow" id="MathJax-Span-21"><span class="mi" id="MathJax-Span-22" style="font-family: MathJax_Math; font-style: italic;">j</span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 1.205em; overflow: hidden; vertical-align: -0.328em; width: 0px;"></span></span></nobr></span> is 1 is the inverse logistic function of the sum of the weights connected to visible unit <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-6-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-23"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 0.417em;"><span style="clip: rect(1.797em, 1000em, 3.079em, -0.637em); left: 0em; position: absolute; top: -2.667em;"><span class="mrow" id="MathJax-Span-24"><span class="mi" id="MathJax-Span-25" style="font-family: MathJax_Math; font-style: italic;">j</span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 1.205em; overflow: hidden; vertical-align: -0.328em; width: 0px;"></span></span></nobr></span>, in which the hidden units are 1. In math notation (where <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-7-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-26"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 0.556em;"><span style="clip: rect(2.027em, 1000em, 2.886em, -0.594em); left: 0em; position: absolute; top: -2.667em;"><span class="mrow" id="MathJax-Span-27"><span class="mi" id="MathJax-Span-28" style="font-family: MathJax_Math; font-style: italic;">σ<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.001em;"></span></span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 0.697em; overflow: hidden; vertical-align: -0.097em; width: 0px;"></span></span></nobr></span> is the inverse logistic, or sigmoid, function):<br /><span class="MathJax_Preview"></span><br /><div class="MathJax_Display" role="textbox" style="text-align: center;"><span class="MathJax" id="MathJax-Element-8-Frame"><nobr><span class="math" id="MathJax-Span-29"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 14.306em;"><span style="clip: rect(1.647em, 1000em, 4.206em, -0.592em); left: 0em; position: absolute; top: -2.806em;"><span class="mrow" id="MathJax-Span-30"><span class="mi" id="MathJax-Span-31" style="font-family: MathJax_Math; font-style: italic;">P<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.109em;"></span></span><span class="mi" id="MathJax-Span-32" style="font-family: MathJax_Math; font-style: italic;">r</span><span class="mo" id="MathJax-Span-33" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-34"><span style="display: inline-block; height: 0px; position: relative; width: 0.839em;"><span style="clip: rect(2.015em, 1000em, 2.886em, -0.604em); left: 0em; position: absolute; top: -2.667em;"><span class="mi" id="MathJax-Span-35" style="font-family: MathJax_Math; font-style: italic;">v</span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span><span style="left: 0.486em; position: absolute; top: -2.031em;"><span class="mi" id="MathJax-Span-36" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">j</span><span style="display: inline-block; height: 2.181em; width: 0px;"></span></span></span></span><span class="mo" id="MathJax-Span-37" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mn" id="MathJax-Span-38" style="font-family: MathJax_Main; padding-left: 0.278em;">1</span><span class="texatom" id="MathJax-Span-39"><span class="mrow" id="MathJax-Span-40"><span class="mo" id="MathJax-Span-41" style="font-family: MathJax_Main;">|</span></span></span><span class="mi" id="MathJax-Span-42" style="font-family: MathJax_Math; font-style: italic;">h</span><span class="mo" id="MathJax-Span-43" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-44" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.167em;">W<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.104em;"></span></span><span class="mo" id="MathJax-Span-45" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-46" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mi" id="MathJax-Span-47" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">σ<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.001em;"></span></span><span class="mo" id="MathJax-Span-48" style="font-family: MathJax_Main;">(</span><span class="munderover" id="MathJax-Span-49"><span style="display: inline-block; height: 0px; position: relative; width: 1.458em;"><span style="clip: rect(2.758em, 1000em, 4.575em, -0.57em); left: 0em; position: absolute; top: -3.917em;"><span class="mo" id="MathJax-Span-50" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; height: 3.917em; width: 0px;"></span></span><span style="clip: rect(1.505em, 1000em, 2.497em, -0.61em); left: 0.59em; position: absolute; top: -1.096em;"><span class="mi" id="MathJax-Span-51" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">i</span><span style="display: inline-block; height: 2.181em; width: 0px;"></span></span></span></span><span class="msubsup" id="MathJax-Span-52" style="padding-left: 0.167em;"><span style="display: inline-block; height: 0px; position: relative; width: 0.908em;"><span style="clip: rect(1.764em, 1000em, 2.886em, -0.577em); left: 0em; position: absolute; top: -2.667em;"><span class="mi" id="MathJax-Span-53" style="font-family: MathJax_Math; font-style: italic;">h</span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span><span style="left: 0.556em; position: absolute; top: -2.031em;"><span class="mi" id="MathJax-Span-54" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">i</span><span style="display: inline-block; height: 2.181em; width: 0px;"></span></span></span></span><span class="msubsup" id="MathJax-Span-55"><span style="display: inline-block; height: 0px; position: relative; width: 1.777em;"><span style="clip: rect(1.775em, 1000em, 2.897em, -0.574em); left: 0em; position: absolute; top: -2.667em;"><span class="mi" id="MathJax-Span-56" style="font-family: MathJax_Math; font-style: italic;">W<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.104em;"></span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span><span style="left: 0.938em; position: absolute; top: -2.169em;"><span class="texatom" id="MathJax-Span-57"><span class="mrow" id="MathJax-Span-58"><span class="mi" id="MathJax-Span-59" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">i</span><span class="mo" id="MathJax-Span-60" style="font-family: MathJax_Main; font-size: 70.7%;">,</span><span class="mi" id="MathJax-Span-61" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">j</span></span></span><span style="display: inline-block; height: 2.319em; width: 0px;"></span></span></span></span><span class="mo" id="MathJax-Span-62" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-63" style="font-family: MathJax_Main;">.</span></span><span style="display: inline-block; height: 2.806em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 2.737em; overflow: hidden; vertical-align: -1.514em; width: 0px;"></span></span></nobr></span></div><br />The weights are symmetric, so<br /><span class="MathJax_Preview"></span><br /><div class="MathJax_Display" role="textbox" style="text-align: center;"><span class="MathJax" id="MathJax-Element-9-Frame"><nobr><span class="math" id="MathJax-Span-64"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 14.167em;"><span style="clip: rect(1.647em, 1000em, 4.342em, -0.592em); left: 0em; position: absolute; top: -2.806em;"><span class="mrow" id="MathJax-Span-65"><span class="mi" id="MathJax-Span-66" style="font-family: MathJax_Math; font-style: italic;">P<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.109em;"></span></span><span class="mi" id="MathJax-Span-67" style="font-family: MathJax_Math; font-style: italic;">r</span><span class="mo" id="MathJax-Span-68" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-69"><span style="display: inline-block; height: 0px; position: relative; width: 0.908em;"><span style="clip: rect(1.764em, 1000em, 2.886em, -0.577em); left: 0em; position: absolute; top: -2.667em;"><span class="mi" id="MathJax-Span-70" style="font-family: MathJax_Math; font-style: italic;">h</span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span><span style="left: 0.556em; position: absolute; top: -2.031em;"><span class="mi" id="MathJax-Span-71" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">i</span><span style="display: inline-block; height: 2.181em; width: 0px;"></span></span></span></span><span class="mo" id="MathJax-Span-72" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mn" id="MathJax-Span-73" style="font-family: MathJax_Main; padding-left: 0.278em;">1</span><span class="texatom" id="MathJax-Span-74"><span class="mrow" id="MathJax-Span-75"><span class="mo" id="MathJax-Span-76" style="font-family: MathJax_Main;">|</span></span></span><span class="mi" id="MathJax-Span-77" style="font-family: MathJax_Math; font-style: italic;">v</span><span class="mo" id="MathJax-Span-78" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-79" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.167em;">W<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.104em;"></span></span><span class="mo" id="MathJax-Span-80" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-81" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mi" id="MathJax-Span-82" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">σ<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.001em;"></span></span><span class="mo" id="MathJax-Span-83" style="font-family: MathJax_Main;">(</span><span class="munderover" id="MathJax-Span-84"><span style="display: inline-block; height: 0px; position: relative; width: 1.458em;"><span style="clip: rect(2.758em, 1000em, 4.575em, -0.57em); left: 0em; position: absolute; top: -3.917em;"><span class="mo" id="MathJax-Span-85" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; height: 3.917em; width: 0px;"></span></span><span style="clip: rect(1.505em, 1000em, 2.633em, -0.633em); left: 0.59em; position: absolute; top: -1.096em;"><span class="mi" id="MathJax-Span-86" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">j</span><span style="display: inline-block; height: 2.181em; width: 0px;"></span></span></span></span><span class="msubsup" id="MathJax-Span-87" style="padding-left: 0.167em;"><span style="display: inline-block; height: 0px; position: relative; width: 0.839em;"><span style="clip: rect(2.015em, 1000em, 2.886em, -0.604em); left: 0em; position: absolute; top: -2.667em;"><span class="mi" id="MathJax-Span-88" style="font-family: MathJax_Math; font-style: italic;">v</span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span><span style="left: 0.486em; position: absolute; top: -2.031em;"><span class="mi" id="MathJax-Span-89" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">j</span><span style="display: inline-block; height: 2.181em; width: 0px;"></span></span></span></span><span class="msubsup" id="MathJax-Span-90"><span style="display: inline-block; height: 0px; position: relative; width: 1.777em;"><span style="clip: rect(1.775em, 1000em, 2.897em, -0.574em); left: 0em; position: absolute; top: -2.667em;"><span class="mi" id="MathJax-Span-91" style="font-family: MathJax_Math; font-style: italic;">W<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.104em;"></span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span><span style="left: 0.938em; position: absolute; top: -2.169em;"><span class="texatom" id="MathJax-Span-92"><span class="mrow" id="MathJax-Span-93"><span class="mi" id="MathJax-Span-94" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">i</span><span class="mo" id="MathJax-Span-95" style="font-family: MathJax_Main; font-size: 70.7%;">,</span><span class="mi" id="MathJax-Span-96" style="font-family: MathJax_Math; font-size: 70.7%; font-style: italic;">j</span></span></span><span style="display: inline-block; height: 2.319em; width: 0px;"></span></span></span></span><span class="mo" id="MathJax-Span-97" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-98" style="font-family: MathJax_Main;">.</span></span><span style="display: inline-block; height: 2.806em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 2.901em; overflow: hidden; vertical-align: -1.677em; width: 0px;"></span></span></nobr></span></div>As you can see, the model is defined by its conditional probabilities. The task is to find the weight matrix <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-10-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-99"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 1.042em;"><span style="clip: rect(1.775em, 1000em, 2.897em, -0.574em); left: 0em; position: absolute; top: -2.667em;"><span class="mrow" id="MathJax-Span-100"><span class="mi" id="MathJax-Span-101" style="font-family: MathJax_Math; font-style: italic;">W<span style="display: inline-block; height: 1px; overflow: hidden; width: 0.104em;"></span></span></span><span style="display: inline-block; height: 2.667em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 1.013em; overflow: hidden; vertical-align: -0.11em; width: 0px;"></span></span></nobr></span> that best explains the visible data for a given number of hidden units.<br /><br />I have been taking Geoff Hinton&#8217;s <a href="https://class.coursera.org/neuralnets-2012-001/">coursera course</a> on neural networks, which I would recommend to anyone interested. One  of the programming assignments was to fill in code to write an RBM in  Matlab/Octave. I have since tried to find a version for R, but have not  had any luck, so I decided to translate the code myself. Below is the  code to calculate the weight matrix. It is fairly simple and I only use  contrastive divergence 1. The input data is <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-11-Frame" role="textbox"><nobr><span class="math" id="MathJax-Span-102"><span style="display: inline-block; font-size: 120%; height: 0px; position: relative; width: 2.292em;"><span style="clip: rect(2.106em, 1000em, 3.208em, -0.664em); left: 0em; position: absolute; top: -2.806em;"><span class="mrow" id="MathJax-Span-103"><span class="mi" id="MathJax-Span-104" style="font-family: MathJax_Math; font-style: italic;">p</span><span class="mo" id="MathJax-Span-105" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-106" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">n</span></span><span style="display: inline-block; height: 2.806em; width: 0px;"></span></span></span><span style="border-left: 0em solid; display: inline-block; height: 0.989em; overflow: hidden; vertical-align: -0.316em; width: 0px;"></span></span></nobr></span> instead of the usual transpose.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><span style="color: #666666; font-style: italic;"># rbm_w is a matrix of size &lt;number of hidden units&gt; by &lt;number of visible units&gt;</span><br /><span style="color: #666666; font-style: italic;"># visible_state is matrix of size &lt;number of visible units&gt; by &lt;number of data cases&gt;</span><br /><span style="color: #666666; font-style: italic;"># hidden_state is a binary matrix of size &lt;number of hidden units&gt; by &lt;number of data cases&gt;</span><br />&nbsp;<br />visible_state_to_hidden_probabilities &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>rbm_w<span style="color: #339933;">,</span> visible_state<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <span style="color: #cc66cc;">1</span>/<span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span>+<a href="http://inside-r.org/r-doc/base/exp"><span style="color: #003399; font-weight: bold;">exp</span></a><span style="color: #009900;">(</span>-rbm_w %*% visible_state<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />hidden_state_to_visible_probabilities &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>rbm_w<span style="color: #339933;">,</span> hidden_state<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <span style="color: #cc66cc;">1</span>/<span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span>+<a href="http://inside-r.org/r-doc/base/exp"><span style="color: #003399; font-weight: bold;">exp</span></a><span style="color: #009900;">(</span>-<a href="http://inside-r.org/r-doc/base/t"><span style="color: #003399; font-weight: bold;">t</span></a><span style="color: #009900;">(</span>rbm_w<span style="color: #009900;">)</span> %*% hidden_state<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />configuration_goodness &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>rbm_w<span style="color: #339933;">,</span> visible_state<span style="color: #339933;">,</span> hidden_state<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  out=<span style="color: #cc66cc;">0</span><br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>i <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/dim"><span style="color: #003399; font-weight: bold;">dim</span></a><span style="color: #009900;">(</span>visible_state<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    out=out+<a href="http://inside-r.org/r-doc/base/t"><span style="color: #003399; font-weight: bold;">t</span></a><span style="color: #009900;">(</span>hidden_state<span style="color: #009900;">[</span><span style="color: #339933;">,</span>i<span style="color: #009900;">]</span><span style="color: #009900;">)</span> %*% rbm_w %*% visible_state<span style="color: #009900;">[</span><span style="color: #339933;">,</span>i<span style="color: #009900;">]</span><br />  <span style="color: #009900;">}</span><br />  out/dim<span style="color: #009900;">(</span>visible_state<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />configuration_goodness_gradient &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>visible_state<span style="color: #339933;">,</span> hidden_state<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  hidden_state %*% <a href="http://inside-r.org/r-doc/base/t"><span style="color: #003399; font-weight: bold;">t</span></a><span style="color: #009900;">(</span>visible_state<span style="color: #009900;">)</span>/dim<span style="color: #009900;">(</span>visible_state<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />sample_bernoulli &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>mat<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  dims=<a href="http://inside-r.org/r-doc/base/dim"><span style="color: #003399; font-weight: bold;">dim</span></a><span style="color: #009900;">(</span>mat<span style="color: #009900;">)</span><br />  <a href="http://inside-r.org/r-doc/base/matrix"><span style="color: #003399; font-weight: bold;">matrix</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/rbinom"><span style="color: #003399; font-weight: bold;">rbinom</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/prod"><span style="color: #003399; font-weight: bold;">prod</span></a><span style="color: #009900;">(</span>dims<span style="color: #009900;">)</span><span style="color: #339933;">,</span>size=<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><a href="http://inside-r.org/packages/cran/prob">prob</a>=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span>mat<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>dims<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>dims<span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />cd1 &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>rbm_w<span style="color: #339933;">,</span> visible_data<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  visible_data = sample_bernoulli<span style="color: #009900;">(</span>visible_data<span style="color: #009900;">)</span><br />  H0=sample_bernoulli<span style="color: #009900;">(</span>visible_state_to_hidden_probabilities<span style="color: #009900;">(</span>rbm_w<span style="color: #339933;">,</span> visible_data<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />  vh0=configuration_goodness_gradient<span style="color: #009900;">(</span>visible_data<span style="color: #339933;">,</span> H0<span style="color: #009900;">)</span><br />  V1=sample_bernoulli<span style="color: #009900;">(</span>hidden_state_to_visible_probabilities<span style="color: #009900;">(</span>rbm_w<span style="color: #339933;">,</span> H0<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />  H1=visible_state_to_hidden_probabilities<span style="color: #009900;">(</span>rbm_w<span style="color: #339933;">,</span> V1<span style="color: #009900;">)</span><br />  vh1=configuration_goodness_gradient<span style="color: #009900;">(</span>V1<span style="color: #339933;">,</span> H1<span style="color: #009900;">)</span><br />  vh0-vh1<br /><span style="color: #009900;">}</span><br />&nbsp;<br />rbm &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>num_hidden<span style="color: #339933;">,</span> training_data<span style="color: #339933;">,</span> learning_rate<span style="color: #339933;">,</span> n_iterations<span style="color: #339933;">,</span> mini_batch_size=<span style="color: #cc66cc;">100</span><span style="color: #339933;">,</span> momentum=<span style="color: #cc66cc;">0.9</span><span style="color: #339933;">,</span> quiet=<span style="color: black; font-weight: bold;">FALSE</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br /><span style="color: #666666; font-style: italic;">#   This trains a model that's defined by a single matrix of weights.</span><br /><span style="color: #666666; font-style: italic;">#   &lt;num_hidden&gt; is the number of hidden units</span><br /><span style="color: #666666; font-style: italic;">#   cd1 is a function that takes parameters &lt;model&gt; and &lt;data&gt; and returns the gradient (or approximate gradient in the case of CD-1) of the function that we're maximizing. Note the contrast with the loss function that we saw in PA3, which we were minimizing. The returned gradient is an array of the same shape as the provided &lt;model&gt; parameter.</span><br /><span style="color: #666666; font-style: italic;">#   This uses mini-batches no weight decay and no early stopping.</span><br /><span style="color: #666666; font-style: italic;">#   This returns the matrix of weights of the trained model.</span><br />  n=<a href="http://inside-r.org/r-doc/base/dim"><span style="color: #003399; font-weight: bold;">dim</span></a><span style="color: #009900;">(</span>training_data<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><br />  p=<a href="http://inside-r.org/r-doc/base/dim"><span style="color: #003399; font-weight: bold;">dim</span></a><span style="color: #009900;">(</span>training_data<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>n %% mini_batch_size != <span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <a href="http://inside-r.org/r-doc/base/stop"><span style="color: #003399; font-weight: bold;">stop</span></a><span style="color: #009900;">(</span><span style="color: blue;">"the number of test cases must be divisable by the mini_batch_size"</span><span style="color: #009900;">)</span><br />  <span style="color: #009900;">}</span><br />  model = <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/matrix"><span style="color: #003399; font-weight: bold;">matrix</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/runif"><span style="color: #003399; font-weight: bold;">runif</span></a><span style="color: #009900;">(</span>num_hidden*p<span style="color: #009900;">)</span><span style="color: #339933;">,</span>num_hidden<span style="color: #339933;">,</span>p<span style="color: #009900;">)</span> * <span style="color: #cc66cc;">2</span> - <span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span> * <span style="color: #cc66cc;">0.1</span><br />  momentum_speed = <a href="http://inside-r.org/r-doc/base/matrix"><span style="color: #003399; font-weight: bold;">matrix</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span>num_hidden<span style="color: #339933;">,</span>p<span style="color: #009900;">)</span><br />&nbsp;<br />  start_of_next_mini_batch = <span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span><br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>iteration_number <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:n_iterations<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>!quiet<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><a href="http://inside-r.org/r-doc/base/cat"><span style="color: #003399; font-weight: bold;">cat</span></a><span style="color: #009900;">(</span><span style="color: blue;">"Iter"</span><span style="color: #339933;">,</span>iteration_number<span style="color: #339933;">,</span><span style="color: blue;">"<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #009900;">}</span><br />    mini_batch = training_data<span style="color: #009900;">[</span><span style="color: #339933;">,</span> start_of_next_mini_batch:<span style="color: #009900;">(</span>start_of_next_mini_batch + mini_batch_size - <span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><br />    start_of_next_mini_batch = <span style="color: #009900;">(</span>start_of_next_mini_batch + mini_batch_size<span style="color: #009900;">)</span> %% n<br />    gradient = cd1<span style="color: #009900;">(</span>model<span style="color: #339933;">,</span> mini_batch<span style="color: #009900;">)</span><br />    momentum_speed = momentum * momentum_speed + gradient<br />    model = model + momentum_speed * learning_rate<br />  <span style="color: #009900;">}</span><br />  <a href="http://inside-r.org/r-doc/base/return"><span style="color: #003399; font-weight: bold;">return</span></a><span style="color: #009900;">(</span>model<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br />I loaded the hand written digit data that was given in the class. To train the RBM, use the syntax below.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/r-doc/stats/weights"><span style="color: #003399; font-weight: bold;">weights</span></a>=rbm<span style="color: #009900;">(</span>num_hidden=<span style="color: #cc66cc;">30</span><span style="color: #339933;">,</span> training_data=train<span style="color: #339933;">,</span> learning_rate=<span style="color: #cc66cc;">.09</span><span style="color: #339933;">,</span> n_iterations=<span style="color: #cc66cc;">5000</span><span style="color: #339933;">,</span><br />            mini_batch_size=<span style="color: #cc66cc;">100</span><span style="color: #339933;">,</span> momentum=<span style="color: #cc66cc;">0.9</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br />After training the weights, I can visualize them. Below is a plot of  strength of the weights going to each pixel. Each facet displays the  weights going to/coming from one of the hidden units. I trained 30 units  so that it would be easy to show them all on one plot. You can see that  most of the hidden units correspond strongly to one digit or another. I  think this means it is finding the joint structure of all of the pixels  and that pixels representing those numbers are darkened together often.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span>reshape2<span style="color: #009900;">)</span><br />mw=melt<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/weights"><span style="color: #003399; font-weight: bold;">weights</span></a><span style="color: #009900;">)</span><span style="color: #339933;">;</span> mw$Var3=<a href="http://inside-r.org/r-doc/base/floor"><span style="color: #003399; font-weight: bold;">floor</span></a><span style="color: #009900;">(</span><span style="color: #009900;">(</span>mw$Var2-<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span>/<span style="color: #cc66cc;">16</span><span style="color: #009900;">)</span>+<span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span> mw$Var2=<span style="color: #009900;">(</span>mw$Var2-<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span>%%16 + <span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span> mw$Var3=<span style="color: #cc66cc;">17</span>-mw$Var3<span style="color: #339933;">;</span><br /><a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a>=mw<span style="color: #009900;">)</span>+geom_tile<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>Var2<span style="color: #339933;">,</span>Var3<span style="color: #339933;">,</span>fill=value<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+facet_wrap<span style="color: #009900;">(</span>~Var1<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/nrow"><span style="color: #003399; font-weight: bold;">nrow</span></a>=<span style="color: #cc66cc;">5</span><span style="color: #009900;">)</span>+<br />  scale_fill_continuous<span style="color: #009900;">(</span>low=<span style="color: blue;">'white'</span><span style="color: #339933;">,</span>high=<span style="color: blue;">'black'</span><span style="color: #009900;">)</span>+coord_equal<span style="color: #009900;">(</span><span style="color: #009900;">)</span>+<br />  labs<span style="color: #009900;">(</span>x=<span style="color: black; font-weight: bold;">NULL</span><span style="color: #339933;">,</span>y=<span style="color: black; font-weight: bold;">NULL</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/graphics/title"><span style="color: #003399; font-weight: bold;">title</span></a>=<span style="color: blue;">"Visualization of Weights"</span><span style="color: #009900;">)</span>+<br />  theme<span style="color: #009900;">(</span>legend.position=<span style="color: blue;">"none"</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-ZSuYvhPTiI4/UPAlFt8sYJI/AAAAAAAAHpo/DcATXHnKMPU/s1600/unnamed-chunk-4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-ZSuYvhPTiI4/UPAlFt8sYJI/AAAAAAAAHpo/DcATXHnKMPU/s1600/unnamed-chunk-4.png" /></a></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Andrew Landgraf</div>
<div class='content'>
There are no biases in this implementation. You could make v_1=1, but there still wouldn&#39;t be biases in the hidden units.</div>
</div>
<div class='comment'>
<div class='author'>sidharth</div>
<div class='content'>
where are the biases ? have you included them in the weights ?</div>
</div>
<div class='comment'>
<div class='author'>Andrew Landgraf</div>
<div class='content'>
The weights are randomly initialized, so any 2 runs will give different results. However, if your figure looks similar to mine, in that it looks like the weights represent numbers, I would say it is working correctly.</div>
</div>
<div class='comment'>
<div class='author'>Xiaolin Gui</div>
<div class='content'>
Thank you for sharing your code.I found the output figure had different with yours when I  do the experiment. I have load the MNIST image data successfully. And the data&#39;s format is 784 ×60000.  The pixels have been binarization. &gt;= 127——&gt;1.<br />I hope you give me some advice.<br />email:guixiaolinde@gmail.com </div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
I have managed to import the training data (from the Coursera website) into R:<br /><br />library(R.matlab)<br />dat = readMat(&quot;data_set.mat&quot;)<br />&#8230;&#8230;<br />weights=rbm(num_hidden=30, training_data= dat$data[,,1]$training[[1]], learning_rate=.09, n_iterations=5000,<br />            mini_batch_size=100, momentum=0.9)<br /></div>
</div>
<div class='comment'>
<div class='author'>Kent Johnson</div>
<div class='content'>
R code for assignment 4 was posted here:<br />https://class.coursera.org/neuralnets-2012-001/forum/thread?thread_id=87&amp;post_id=5105<br />I used it as the basis for a work project.</div>
</div>
<div class='comment'>
<div class='author'>Zachary Mayer</div>
<div class='content'>
I believe there&#39;s also a kaggle competition using that data right now: http://www.kaggle.com/c/digit-recognizer</div>
</div>
<div class='comment'>
<div class='author'>Andrew</div>
<div class='content'>
I don&#39;t want to post it here because of possible copyright violations, but you can download it in Octave format from the Coursera site (in programming assignment 4) or you can find it at this webpage: http://yann.lecun.com/exdb/mnist/</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Do you have a sample of training data?</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/09/factor-analysis-of-baseballs-hall-of/">Factor Analysis of Baseball&#8217;s Hall of Fame Voters</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-09T00:00:00-05:00" pubdate data-updated="true">Jan 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<!-- saved from url=(0014)about:internet --><html><head>  <title>Factor Analysis of Baseball&#8217;s Hall of Fame Voters</title> <style type="text/css">body, td {    font-family: sans-serif;    background-color: white;    font-size: 12px;    margin: 8px; }  tt, code, pre {    font-family: &#8216;DejaVu Sans Mono&#8217;, &#8216;Droid Sans Mono&#8217;, &#8216;Lucida Console&#8217;, Consolas, Monaco, monospace; }  h1 {     font-size:2.2em;  }  h2 {     font-size:1.8em;  }  h3 {     font-size:1.4em;  }  h4 {     font-size:1.0em;  }  h5 {     font-size:0.9em;  }  h6 {     font-size:0.8em;  }  a:visited {    color: rgb(50%, 0%, 50%); }  pre {     margin-top: 0;    max-width: 95%;    border: 1px solid #ccc;    white-space: pre-wrap; }  pre code {    display: block; padding: 0.5em; }  code.r, code.cpp {    background-color: #F8F8F8; }  table, td, th {   border: none; }  blockquote {    color:#666666;    margin:0;    padding-left: 1em;    border-left: 0.5em #EEE solid; }  hr {    height: 0px;    border-bottom: none;    border-top-width: thin;    border-top-style: dotted;    border-top-color: #999999; }  @media print {    * {        background: transparent !important;        color: black !important;        filter:none !important;        -ms-filter: none !important;     }     body {        font-size:12pt;        max-width:100%;     }            a, a:visited {        text-decoration: underline;     }     hr {        visibility: hidden;       page-break-before: always;    }     pre, blockquote {        padding-right: 1em;        page-break-inside: avoid;     }     tr, img {        page-break-inside: avoid;     }     img {        max-width: 100% !important;     }     @page :left {        margin: 15mm 20mm 15mm 10mm;     }          @page :right {        margin: 15mm 10mm 15mm 20mm;     }     p, h2, h3 {        orphans: 3; widows: 3;     }     h2, h3 {        page-break-after: avoid;     } }  </style> <style type="text/css">   pre .operator,    pre .paren {      color: rgb(104, 118, 135)    }     pre .literal {      color: rgb(88, 72, 246)    }     pre .number {      color: rgb(0, 0, 205);    }     pre .comment {      color: rgb(76, 136, 107);    }     pre .keyword {      color: rgb(0, 0, 255);    }     pre .identifier {      color: rgb(0, 0, 0);    }     pre .string {      color: rgb(3, 106, 7);    } </style> <script type="text/javascript">var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre><code>"+y.value+"</code></pre>&#8220;;t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName(&#8220;pre&#8221;);for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|&#92;?|&#92;[|&#92;{|&#92;(|&#92;^|&#92;^=|&#92;||&#92;|=|&#92;|&#92;||~&#8221;;this.ER=&#8221;(?![&#92;s&#92;S])&#8221;;this.BE={b:&#8221;&#92;&#92;.&#8221;,r:0};this.ASM={cN:&#8221;string&#8221;,b:&#8221;&#8217;&#8221;,e:&#8221;&#8217;&#8221;,i:&#8221;&#92;n&#8221;,c:[this.BE],r:0};this.QSM={cN:&#8221;string&#8221;,b:&#8217;&#8221;&#8217;,e:&#8217;&#8221;&#8217;,i:&#8221;&#92;n&#8221;,c:[this.BE],r:0};this.CLCM={cN:&#8221;comment&#8221;,b:&#8221;//&#8221;,e:&#8221;$&#8221;};this.CBLCLM={cN:&#8221;comment&#8221;,b:&#8221;/&#92;*&#8221;,e:&#8221;&#92;*/&#8221;};this.HCM={cN:&#8221;comment&#8221;,b:&#8221;#&#8221;,e:&#8221;$&#8221;};this.NM={cN:&#8221;number&#8221;,b:this.NR,r:0};this.CNM={cN:&#8221;number&#8221;,b:this.CNR,r:0};this.BNM={cN:&#8221;number&#8221;,b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{&#8220;false&#8221;:1,&#8221;int&#8221;:1,&#8221;float&#8221;:1,&#8221;while&#8221;:1,&#8221;private&#8221;:1,&#8221;char&#8221;:1,&#8221;catch&#8221;:1,&#8221;export&#8221;:1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,&#8221;const&#8221;:1,struct:1,&#8221;for&#8221;:1,static_cast:2,union:1,namespace:1,unsigned:1,&#8221;long&#8221;:1,&#8221;throw&#8221;:1,&#8221;volatile&#8221;:2,&#8221;static&#8221;:1,&#8221;protected&#8221;:1,bool:1,template:1,mutable:1,&#8221;if&#8221;:1,&#8221;public&#8221;:1,friend:2,&#8221;do&#8221;:1,&#8221;return&#8221;:1,&#8221;goto&#8221;:1,auto:1,&#8221;void&#8221;:2,&#8221;enum&#8221;:1,&#8221;else&#8221;:1,&#8221;break&#8221;:1,&#8221;new&#8221;:1,extern:1,using:1,&#8221;true&#8221;:1,&#8221;class&#8221;:1,asm:1,&#8221;case&#8221;:1,typeid:1,&#8221;short&#8221;:1,reinterpret_cast:2,&#8221;default&#8221;:1,&#8221;double&#8221;:1,register:1,explicit:1,signed:1,typename:1,&#8221;try&#8221;:1,&#8221;this&#8221;:1,&#8221;switch&#8221;:1,&#8221;continue&#8221;:1,wchar_t:1,inline:1,&#8221;delete&#8221;:1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:&#8221;</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">&#8220;,k:a,r:10,c:[&#8220;self&#8221;]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:&#8221;number&#8221;,b:&#8221;&#92;b0[xX][0-9a-fA-F]+[Li]?&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:0},{cN:&#8221;number&#8221;,b:&#8221;&#92;b&#92;d+(?:[eE][+&#92;-]?&#92;d*)?L&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:0},{cN:&#8221;number&#8221;,b:&#8221;&#92;b&#92;d+&#92;.(?!&#92;d)(?:i&#92;b)?&#8221;,e:hljs.IMMEDIATE_RE,r:1},{cN:&#8221;number&#8221;,b:&#8221;&#92;b&#92;d+(?:&#92;.&#92;d*)?(?:[eE][+&#92;-]?&#92;d*)?i?&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:0},{cN:&#8221;number&#8221;,b:&#8221;&#92;.&#92;d+(?:[eE][+&#92;-]?&#92;d*)?i?&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:1},{cN:&#8221;keyword&#8221;,b:&#8221;(?:tryCatch|library|setGeneric|setGroupGeneric)&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:10},{cN:&#8221;keyword&#8221;,b:&#8221;&#92;.&#92;.&#92;.&#8221;,e:hljs.IMMEDIATE_RE,r:10},{cN:&#8221;keyword&#8221;,b:&#8221;&#92;.&#92;.&#92;d+(?![&#92;w.])&#8221;,e:hljs.IMMEDIATE_RE,r:10},{cN:&#8221;keyword&#8221;,b:&#8221;&#92;b(?:function)&#8221;,e:hljs.IMMEDIATE_RE,r:2},{cN:&#8221;keyword&#8221;,b:&#8221;(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:1},{cN:&#8221;literal&#8221;,b:&#8221;(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:10},{cN:&#8221;literal&#8221;,b:&#8221;(?:NULL|TRUE|FALSE|T|F|Inf|NaN)&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:1},{cN:&#8221;identifier&#8221;,b:&#8221;[a-zA-Z.][a-zA-Z0-9._]*&#92;b&#8221;,e:hljs.IMMEDIATE_RE,r:0},{cN:&#8221;operator&#8221;,b:&#8221;<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}}; hljs.initHighlightingOnLoad(); </script>        <br />Recently, Nate Silver wrote <a href="http://fivethirtyeight.blogs.nytimes.com/2013/01/08/suspicion-of-steroid-use-could-keep-bagwell-and-piazza-out-of-hall/">a post</a> which analyzed how voters who voted for and against Barry Bonds for Baseball&#8217;s Hall of Fame differed. Not surprisingly, those who voted for Bonds were more likely to vote for other suspected steroids users (like Roger Clemens). This got me thinking that this would make an interesting case study for factor analysis to see if there are latent factors that drive hall of fame voting.<br /><br />The Twitter user @leokitty has kept track of all the known ballots of the voters in a <a href="https://docs.google.com/spreadsheet/ccc?key=0Aqc4QTMoPrdtdDQxaDYzd1lLOGpOdUdrcnNNNWNXa2c&amp;authkey=CPyuwqIJ&amp;authkey=CPyuwqIJ#gid=6">spreadsheet</a>. The spreadsheet is a matrix that has one row for each voter and one column for each player being voted upon. (Players need 75% of the vote to make it to the hall of fame.) I removed all players that had no votes and all voters that had given a partial ballot.<br /><br />(This matrix either has a 1 or a 0 in each entry, corresponding to whether a voter voted for the player or not. Note that this kind of matrix is similar to the data that is analyzed in information retrieval. I will be decomposing the (centered) matrix using singular value decomposition to run the factor analysis. This is the same technique used for latent semantic indexing in information retrieval.)<br /><br />Starting with the analysis, there is a drop off of the variance  after the first 2 factors, which means it might make sense to look only at the first 2 (which is good because I was only planning on doing so).<br /><br /><pre><code class="r">votes = read.csv("HOF votes.csv", row.names = 1, header = TRUE)<br />pca = princomp(votes)<br />screeplot(pca, type = "l", main = "Scree Plot")<br /></code></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-hLkeU-zL-Ak/UO2Yd0B5z4I/AAAAAAAAHo4/dH27nksEiHM/s1600/unnamed-chunk-2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-hLkeU-zL-Ak/UO2Yd0B5z4I/AAAAAAAAHo4/dH27nksEiHM/s1600/unnamed-chunk-2.png" /></a></div><br />Looking at the loadings, it appears that the first principal component corresponds strongly to steroid users, which Bonds and Clemens having large negative values and other suspected steroid users being on the negative end. The players on the positive end have no steroid suspicions.<br /><br /><pre><code class="r">dotchart(sort(pca$loadings[, 1]), main = "First Principal Component")<br /></code></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-K6MEN_9PcHs/UO2Yd69LeeI/AAAAAAAAHok/Lcb2apHZdC0/s1600/unnamed-chunk-3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-K6MEN_9PcHs/UO2Yd69LeeI/AAAAAAAAHok/Lcb2apHZdC0/s1600/unnamed-chunk-3.png" /></a></div>The second component isn&#8217;t as easy to decipher. The players at the negative end seem to players that are preferred by analytically minded analysts (think Moneyball). Raines, Trammell, and Martinez have more support among this group of voters. Morris, however, has less support among these voters and he isn&#8217;t that far separated from them.<br /><br />There also may be some secondary steroid association in the component as well separating players who have proof of steroid use versus those which have no proof but “look like” they took steroids. For example, there is no hard evidence that Bagwell or Piazza took steroids, but they were very muscular and hit a lot of home runs, so they are believed to have taken steroids. There is some sort of evidence the top five players of this component did take steroids.<br /><br /><pre><code class="r">dotchart(sort(pca$loadings[, 2]), main = "Second Principal Component")<br /></code></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-mKFEcj6ISQU/UO2Yd7ZFDQI/AAAAAAAAHoo/ZBwJgKbcLI4/s1600/unnamed-chunk-4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-mKFEcj6ISQU/UO2Yd7ZFDQI/AAAAAAAAHoo/ZBwJgKbcLI4/s1600/unnamed-chunk-4.png" /></a></div><br />Projecting the votes onto two dimensions, we can look at how the voters for Bonds and Clemens split up. You can see there is a strong horizontal split between the voters for and against Bonds/Clemens. There are also 3 voters that voted for Bonds, but not Clemens.<br /><br /><pre><code class="r">ggplot(data.frame(cbind(pca$scores[, 1:2], votes))) + geom_point(aes(Comp.1, <br />    Comp.2, colour = as.factor(Barry.Bonds), shape = as.factor(Roger.Clemens)), <br />    size = 4) + coord_equal() + labs(colour = "Bonds", shape = "Clemens")<br /></code></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-nQoFe3Gnk4c/UO2YeZBYwkI/AAAAAAAAHos/KftZv63_S6E/s1600/unnamed-chunk-5.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-nQoFe3Gnk4c/UO2YeZBYwkI/AAAAAAAAHos/KftZv63_S6E/s1600/unnamed-chunk-5.png" /></a></div><br />Similarly, I can look at how the voters split up on the issue of steroids by looking at both Bonds and Bagwell. The voters in the upper left do not care about steroid use, but believe that Bagwell wasn&#8217;t good enough to make it to the hall of fame. The voters in the lower right do care about steroid use, but believe that Bagwell was innocent of any wrongdoing.<br /><br /><pre><code class="r">ggplot(data.frame(cbind(pca$scores[, 1:2], votes))) + geom_point(aes(Comp.1, <br />    Comp.2, colour = as.factor(paste(Roger.Clemens, "/", Jeff.Bagwell))), size = 4) + <br />    geom_hline(aes(0), size = 0.2) + geom_vline(aes(0), size = 0.2) + coord_equal() + <br />    labs(colour = "Bonds / Bagwell")<br /></code></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-k4AoH_kJlyc/UO2YfOqnS0I/AAAAAAAAHow/mETFQ33dXVI/s1600/unnamed-chunk-6.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-k4AoH_kJlyc/UO2YfOqnS0I/AAAAAAAAHow/mETFQ33dXVI/s1600/unnamed-chunk-6.png" /></a></div><br />We can also look at a similar plot with Schilling instead of Bagwell. The separation here appears to be stronger.<br /><br /><pre><code class="r">ggplot(data.frame(cbind(pca$scores[, 1:2], votes))) + geom_point(aes(Comp.1, <br />    Comp.2, colour = as.factor(paste(Barry.Bonds, "/", Curt.Schilling))), size = 4) + <br />    geom_hline(aes(0), size = 0.2) + geom_vline(aes(0), size = 0.2) + coord_equal() + <br />    labs(colour = "Bonds / Schilling")<br /></code></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-aSA3fUNxSGY/UO2YftHu8HI/AAAAAAAAHo0/e2Itd9TkE60/s1600/unnamed-chunk-7.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-aSA3fUNxSGY/UO2YftHu8HI/AAAAAAAAHo0/e2Itd9TkE60/s1600/unnamed-chunk-7.png" /></a></div><br />Finally, we can look at a biplot (using code from <a href="http://stackoverflow.com/questions/6578355/plotting-pca-biplot-with-ggplot2">here</a>).<br /><br /><pre><code class="r">PCbiplot &lt;- function(PC = fit, x = "PC1", y = "PC2") {<br />    # PC being a prcomp object<br />    library(grid)<br />    data &lt;- data.frame(obsnames = row.names(PC$x), PC$x)<br />    plot &lt;- ggplot(data, aes_string(x = x, y = y)) + geom_text(alpha = 0.4, <br />        size = 3, aes(label = obsnames))<br />    plot &lt;- plot + geom_hline(aes(0), size = 0.2) + geom_vline(aes(0), size = 0.2)<br />    datapc &lt;- data.frame(varnames = rownames(PC$rotation), PC$rotation)<br />    mult &lt;- min((max(data[, y]) - min(data[, y])/(max(datapc[, y]) - min(datapc[, <br />        y]))), (max(data[, x]) - min(data[, x])/(max(datapc[, x]) - min(datapc[, <br />        x]))))<br />    datapc &lt;- transform(datapc, v1 = 0.7 * mult * (get(x)), v2 = 0.7 * mult * <br />        (get(y)))<br />    plot &lt;- plot + coord_equal() + geom_text(data = datapc, aes(x = v1, y = v2, <br />        label = varnames), size = 5, vjust = 1, color = "red")<br />    plot &lt;- plot + geom_segment(data = datapc, aes(x = 0, y = 0, xend = v1, <br />        yend = v2), arrow = arrow(length = unit(0.2, "cm")), alpha = 0.75, color = "red")<br />    plot<br />}<br /><br />fit &lt;- prcomp(votes, scale = F)<br />PCbiplot(fit)<br /></code></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-MPuCAW6v_zw/UO2YgMRas1I/AAAAAAAAHpA/pHzLYPdb0k4/s1600/unnamed-chunk-8.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-MPuCAW6v_zw/UO2YgMRas1I/AAAAAAAAHpA/pHzLYPdb0k4/s1600/unnamed-chunk-8.png" /></a></div>I could have also attempted to rotate the factors to make them more interpretable, but they appeared to have easy interpretation as is. Since we were looking at 2-d plots, rotation would not have made a difference in interpreting the plots. It is also common to use a likelihood approach to estimate factors. I chose to use the principal component method because the data are definitely not normal (being 0&#8217;s and 1&#8217;s).</head></html></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/05/quick-post-about-getting-and-plotting/">Quick Post About Getting and Plotting Polls in R</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-05T00:00:00-05:00" pubdate data-updated="true">Nov 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
With the election nearly upon us, I wanted to share an easy way I just found to download polling data and graph a few with ggplot2. <a href="https://github.com/dlinzer/pollstR/">dlinzer </a>at github created a function to download poll data from the <a href="http://elections.huffingtonpost.com/pollster/api">Huffington Post&#8217;s Pollster API</a>.<br /><br />The default is to download national tracking polls from the presidential election. After sourcing the function, I load the required packages, download the data, and make the plot.<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/XML">XML</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/reshape"><span style="color: #003399; font-weight: bold;">reshape</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><span style="color: #339933;">;</span> theme_set<span style="color: #009900;">(</span>theme_bw<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />&nbsp;<br />dat &lt;- pollstR<span style="color: #009900;">(</span>pages=<span style="color: #cc66cc;">20</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>dat<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>end.date<span style="color: #339933;">,</span>Obama/<span style="color: #009900;">(</span>Obama+Romney<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+geom_point<span style="color: #009900;">(</span>alpha=<span style="color: #cc66cc;">.5</span><span style="color: #009900;">)</span>+geom_smooth<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>weight=<a href="http://inside-r.org/r-doc/base/sqrt"><span style="color: #003399; font-weight: bold;">sqrt</span></a><span style="color: #009900;">(</span>N<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+geom_hline<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>yintercept=<span style="color: #cc66cc;">0.5</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>lty=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>size=<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span>+<br />  labs<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/graphics/title"><span style="color: #003399; font-weight: bold;">title</span></a>=<span style="color: blue;">"Proportion of Vote for Obama"</span><span style="color: #339933;">,</span>x=<span style="color: blue;">"Last Date of Poll"</span><span style="color: #339933;">,</span>y=<span style="color: black; font-weight: bold;">NULL</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-KXjQJ7sJ0eI/UJhfahhVZCI/AAAAAAAAHW8/nRxJVgXK5Fs/s1600/PollsPlot1.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="512" src="http://4.bp.blogspot.com/-KXjQJ7sJ0eI/UJhfahhVZCI/AAAAAAAAHW8/nRxJVgXK5Fs/s1600/PollsPlot1.jpeg" style="cursor: move;" width="640" /></a></div>I have used transparency so that you can see when there are many polls on top of each other. You can see that Obama&#8217;s lead decreased substantially after the first debate but has crawled back up since then. Of course, I am treating all polls as equal (although I am weighting by sample size) when the truth is that some polls are better than others and some are biased.<br /><br />To have some more fun, I will show what some of the data from swing states look like. The code below loops through the swing states and downloads the polls. Then it plots the polls for each state in different facets.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://4.bp.blogspot.com/-KXjQJ7sJ0eI/UJhfahhVZCI/AAAAAAAAHW8/nRxJVgXK5Fs/s1600/PollsPlot1.jpeg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><a href="http://4.bp.blogspot.com/-KXjQJ7sJ0eI/UJhfahhVZCI/AAAAAAAAHW8/nRxJVgXK5Fs/s1600/PollsPlot1.jpeg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a>swing.states=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">"ohio"</span><span style="color: #339933;">,</span><span style="color: blue;">"florida"</span><span style="color: #339933;">,</span><span style="color: blue;">"virginia"</span><span style="color: #339933;">,</span><span style="color: blue;">"colorado"</span><span style="color: #339933;">,</span><span style="color: blue;">"nevada"</span><span style="color: #339933;">,</span><span style="color: blue;">"north-carolina"</span><span style="color: #009900;">)</span><br /><span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/mgcv/s"><span style="color: #003399; font-weight: bold;">s</span></a> <span style="color: black; font-weight: bold;">in</span> swing.states<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <a href="http://inside-r.org/r-doc/base/print"><span style="color: #003399; font-weight: bold;">print</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/mgcv/s"><span style="color: #003399; font-weight: bold;">s</span></a><span style="color: #009900;">)</span><br />  dat.state &lt;- pollstR<span style="color: #009900;">(</span>chart=<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399; font-weight: bold;">paste</span></a><span style="color: #009900;">(</span><span style="color: blue;">"2012-"</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/mgcv/s"><span style="color: #003399; font-weight: bold;">s</span></a><span style="color: #339933;">,</span><span style="color: blue;">"-president-romney-vs-obama"</span><span style="color: #339933;">,</span>sep=<span style="color: blue;">""</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>pages=<span style="color: blue;">"all"</span><span style="color: #009900;">)</span><br />  dat.state=<a href="http://inside-r.org/r-doc/base/subset"><span style="color: #003399; font-weight: bold;">subset</span></a><span style="color: #009900;">(</span>dat.state<span style="color: #339933;">,</span>select=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">"id"</span><span style="color: #339933;">,</span><span style="color: blue;">"pollster"</span><span style="color: #339933;">,</span><span style="color: blue;">"start.date"</span><span style="color: #339933;">,</span><span style="color: blue;">"end.date"</span><span style="color: #339933;">,</span><span style="color: blue;">"method"</span><span style="color: #339933;">,</span><span style="color: blue;">"N"</span><span style="color: #339933;">,</span><span style="color: blue;">"Obama"</span><span style="color: #339933;">,</span><span style="color: blue;">"Romney"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />  dat.state$State=<a href="http://inside-r.org/r-doc/mgcv/s"><span style="color: #003399; font-weight: bold;">s</span></a><br />&nbsp;<br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/mgcv/s"><span style="color: #003399; font-weight: bold;">s</span></a>==<span style="color: blue;">"ohio"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    dat=dat.state<br />  <span style="color: #009900;">}</span> <span style="color: black; font-weight: bold;">else</span> <span style="color: #009900;">{</span><br />    dat=<a href="http://inside-r.org/r-doc/base/rbind"><span style="color: #003399; font-weight: bold;">rbind</span></a><span style="color: #009900;">(</span>dat<span style="color: #339933;">,</span>dat.state<span style="color: #009900;">)</span><br />  <span style="color: #009900;">}</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span>lubridate<span style="color: #009900;">)</span><br />dat$end.date=ymd<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/as.character"><span style="color: #003399; font-weight: bold;">as.character</span></a><span style="color: #009900;">(</span>dat$end.date<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>dat<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>end.date<span style="color: #339933;">,</span>Obama/<span style="color: #009900;">(</span>Obama+Romney<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+geom_point<span style="color: #009900;">(</span>alpha=<span style="color: #cc66cc;">.5</span><span style="color: #009900;">)</span>+geom_smooth<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>weight=<a href="http://inside-r.org/r-doc/base/sqrt"><span style="color: #003399; font-weight: bold;">sqrt</span></a><span style="color: #009900;">(</span>N<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+geom_hline<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>yintercept=<span style="color: #cc66cc;">0.5</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>lty=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>size=<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span>+<br />  labs<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/graphics/title"><span style="color: #003399; font-weight: bold;">title</span></a>=<span style="color: blue;">"Proportion of Vote for Obama"</span><span style="color: #339933;">,</span>x=<span style="color: blue;">"Last Date of Poll"</span><span style="color: #339933;">,</span>y=<span style="color: black; font-weight: bold;">NULL</span><span style="color: #009900;">)</span>+facet_wrap<span style="color: #009900;">(</span>~State<span style="color: #009900;">)</span>+xlim<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span>mdy<span style="color: #009900;">(</span><span style="color: blue;">"8/1/2012"</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>mdy<span style="color: #009900;">(</span><span style="color: blue;">"11/6/2012"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-FwY5UtHzB-4/UJhkl-qrDgI/AAAAAAAAHXM/LzcRBLshLRM/s1600/PollsPlot2.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="512" src="http://2.bp.blogspot.com/-FwY5UtHzB-4/UJhkl-qrDgI/AAAAAAAAHXM/LzcRBLshLRM/s1600/PollsPlot2.jpeg" width="640" /></a></div>Unfortunately the x-axis didn&#8217;t show up very well, but it starts at August 1. There have been quite a few polls in Ohio and Florida, haven&#8217;t there? The state polls did not have nearly the same shift that the national poll did in reaction to the first debate. The state with the largest bump is Colorado, where the debate was held.<br /><a href="http://4.bp.blogspot.com/-KXjQJ7sJ0eI/UJhfahhVZCI/AAAAAAAAHW8/nRxJVgXK5Fs/s1600/PollsPlot1.jpeg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><a href="http://4.bp.blogspot.com/-KXjQJ7sJ0eI/UJhfahhVZCI/AAAAAAAAHW8/nRxJVgXK5Fs/s1600/PollsPlot1.jpeg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><br />By just looking at the tracking polls, I think you would make the same conclusions that <a href="http://fivethirtyeight.blogs.nytimes.com/">Nate Silver</a> has with his fancy model. Ohio, Virginia, Nevada, and Colorado favor Obama. North Carolina favors Romney and Florida just barely tips toward Romney as well.<br /><br />Finally, here are just the smoothed running means, all on one plot. You can see that There was also a first debate effect in Ohio.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>dat<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>end.date<span style="color: #339933;">,</span>Obama/<span style="color: #009900;">(</span>Obama+Romney<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+geom_smooth<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>colour=State<span style="color: #339933;">,</span>weight=<a href="http://inside-r.org/r-doc/base/sqrt"><span style="color: #003399; font-weight: bold;">sqrt</span></a><span style="color: #009900;">(</span>N<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>se=<span style="color: black; font-weight: bold;">FALSE</span><span style="color: #339933;">,</span>size=<span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span>+geom_hline<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>yintercept=<span style="color: #cc66cc;">0.5</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>lty=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>size=<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span>+<br />  labs<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/graphics/title"><span style="color: #003399; font-weight: bold;">title</span></a>=<span style="color: blue;">"Proportion of Vote for Obama"</span><span style="color: #339933;">,</span>x=<span style="color: blue;">"Last Date of Poll"</span><span style="color: #339933;">,</span>y=<span style="color: black; font-weight: bold;">NULL</span><span style="color: #009900;">)</span>+xlim<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span>mdy<span style="color: #009900;">(</span><span style="color: blue;">"8/1/2012"</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>mdy<span style="color: #009900;">(</span><span style="color: blue;">"11/6/2012"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-nN9GHK_W6Zs/UJhpDsnKArI/AAAAAAAAHXc/RBVNGzoM7tQ/s1600/PollsPlot3.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-nN9GHK_W6Zs/UJhpDsnKArI/AAAAAAAAHXc/RBVNGzoM7tQ/s1600/PollsPlot3.jpeg" height="347" width="640" /></a></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Andrew Clark</div>
<div class='content'>
Interesting work. Thanks for the tip on the API/github. I have had a look at the GOP campaign - surely one of the strangest in history<br />http://wp.me/p17axt-jK</div>
</div>
<div class='comment'>
<div class='author'>Andrew</div>
<div class='content'>
Thanks for the tip. To add more information to the national tracker plot, you can make the of the points relative to the number polled. Also facet it by the type of poll. Like this:<br /><br />ggplot(dat,aes(end.date,Obama/(Obama+Romney)))+<br />  geom_point(aes(size=sqrt(N)),alpha=.5)+<br />  geom_smooth(aes(weight=sqrt(N)))+<br />  geom_hline(aes(yintercept=0.5),lty=2,size=1)+<br />  labs(title=&quot;Proportion of Vote for Obama&quot;,x=&quot;Last Date of Poll&quot;,y=NULL)+<br />  facet_wrap(~method)+<br />  theme(axis.text.x=element_text(angle=-90))</div>
</div>
<div class='comment'>
<div class='author'>Tony Hirst</div>
<div class='content'>
You can tidy up the x-axis labels by rotating them, eg using something like:<br />+theme(axis.text.x=element_text(angle=-90))</div>
</div>
<div class='comment'>
<div class='author'>Tony Hirst</div>
<div class='content'>
This comment has been removed by the author.</div>
</div>
</div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/12/27/top-songs-by-artist-on-cd1025-in-2013/">Top Songs by Artist on CD102.5 in 2013</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/27/when-did-cd1025-book-summerfest-artists/">When Did CD102.5 Book the Summerfest Artists?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/20/downloading-and-analyzing-cd1025s/">Downloading and Analyzing CD1025&#8217;s Playlist</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/21/what-is-probability-of-16-seed-beating/">What Is the Probability of a 16 Seed Beating a 1 Seed?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/18/easily-access-academic-journals-off/">Easily Access Academic Journals Off Campus With a Firefox Bookmark</a>
      </li>
    
  </ul>
</section>
Included file &#8216;asides/twitter.html&#8217; not found in _includes directory




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Andrew Landgraf -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andland';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
