<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: optimization | Statistically Significant]]></title>
  <link href="http://andland.github.io/blog/categories/optimization/atom.xml" rel="self"/>
  <link href="http://andland.github.io/"/>
  <updated>2014-04-22T21:37:30-04:00</updated>
  <id>http://andland.github.io/</id>
  <author>
    <name><![CDATA[Andrew Landgraf]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Text Decryption Using MCMC]]></title>
    <link href="http://andland.github.io/blog/2013/01/23/text-decryption-using-mcmc/"/>
    <updated>2013-01-23T00:00:00-05:00</updated>
    <id>http://andland.github.io/blog/2013/01/23/text-decryption-using-mcmc</id>
    <content type="html"><![CDATA[<div class="post">
The famous probabilist and statistician Persi Diaconis wrote an article not too long ago about the "<a href="http://math.uchicago.edu/~shmuel/Network-course-readings/MCMCRev.pdf" target="_blank">Markov chain Monte Carlo (MCMC) Revolution</a>." The paper describes how we are able to solve a diverse set of problems with MCMC. The first example he gives is a text decryption problem solved with a simple Metropolis Hastings sampler.<br /><br />I was always stumped by those <a href="https://en.wikipedia.org/wiki/Cryptogram" target="_blank">cryptograms</a> in the newspaper and thought it would be pretty cool if I could crack them with statistics. So I decided to try it out on my own. The example Diaconis gives is fleshed out in more details by its original authors in its own <a href="http://probability.ca/jeff/ftpdir/decipherart.pdf" target="_blank">article</a>. <br /><br />The decryption I will be attempting is called <a href="https://en.wikipedia.org/wiki/Substitution_cipher" target="_blank">substitution cipher</a>, where each letter of the alphabet corresponds to another letter (possibly the same one). This is the rule that you must follow for the cryptogram game too. There are 26! = 4e26 possible mappings of the letters of the alphabet to one another. This seems like a hopeless problem to solve, but I will show you that a relatively simple solution can be found as long as your reference text is large enough and the text you are trying to decipher is also large enough.<br /><br />The strategy is to use a reference text to create transition probabilities from each letter to the next. This can be stored in a 26 by 26 matrix, where the ith row and jth column is the probability of the jth letter, given the ith letter preceded it. For example, the given the previous letter was a Q, U almost always follows it, so the Q-row and U-column would be close to probability of 1. Assuming these one step transition probabilities are what matter, the likelihood of any mapping is the product of the transition probabilities observed.<br /><br />To create a transition matrix, I downloaded <i>War and Peace </i>from <a href="http://www.gutenberg.org/dirs/2/6/0/2600/2600.txt" target="_blank">Project Gutenberg</a>. I looped through each letter and kept track of the number of number of times each letter followed the previous. I also kept track of a 27th character, which was anything that was not a letter -- for example periods, commas, spaces, etc. This lets me know which letters are more likely to start a word or end a word. Consecutive entries of these special characters are not considered.<br /><br />After I have these counts, I normalize by dividing by the row total. Before normalizing, I add 1 to each cell so that there are no probabilities of 0. This also corresponds to prior information of each transition being equally likely. I could have tried to give more informative prior information (like Q to U being likely), but it would have been difficult and probably inaccurate for the whole matrix.<br /><br />Below is the code for creating the transition probability matrix. Note that I loop through each line and within each line I loop through each character.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">reference=<a href="http://inside-r.org/r-doc/base/readLines"><span style="color: #003399; font-weight: bold;">readLines</span></a><span style="color: #009900;">(</span><span style="color: blue;">"warandpeace.txt"</span><span style="color: #009900;">)</span><br />reference=<a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">)</span><br />&nbsp;<br />trans.mat=<a href="http://inside-r.org/r-doc/base/matrix"><span style="color: #003399; font-weight: bold;">matrix</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><span style="color: blue;">""</span><span style="color: #009900;">)</span><br />lastletter=<span style="color: blue;">""</span><br /><span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>ln <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/length"><span style="color: #003399; font-weight: bold;">length</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>ln %% <span style="color: #cc66cc;">1000</span> ==<span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><a href="http://inside-r.org/r-doc/base/cat"><span style="color: #003399; font-weight: bold;">cat</span></a><span style="color: #009900;">(</span><span style="color: blue;">"Line"</span><span style="color: #339933;">,</span>ln<span style="color: #339933;">,</span><span style="color: blue;">"<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><span style="color: #009900;">}</span><br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>pos <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/nchar"><span style="color: #003399; font-weight: bold;">nchar</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">[</span>ln<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    curletter=<a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>reference<span style="color: #009900;">[</span>ln<span style="color: #009900;">]</span><span style="color: #339933;">,</span>pos<span style="color: #339933;">,</span>pos<span style="color: #009900;">)</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>curletter %in% <a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><br />                <a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==curletter<span style="color: #009900;">]</span>=<br />        trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><br />                  <a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==curletter<span style="color: #009900;">]</span>+<span style="color: #cc66cc;">1</span><br />      lastletter=curletter<br />    <span style="color: #009900;">}</span> <span style="color: black; font-weight: bold;">else</span> <span style="color: #009900;">{</span><br />      <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />        trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>=<br />          trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>+<span style="color: #cc66cc;">1</span><br />        lastletter=<span style="color: blue;">""</span><br />      <span style="color: #009900;">}</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br />  curletter=<span style="color: blue;">""</span><br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>=<br />      trans.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span>+<span style="color: #cc66cc;">1</span><br />  <span style="color: #009900;">}</span><br />  lastletter=<span style="color: blue;">""</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />trans.prob.mat=<a href="http://inside-r.org/r-doc/base/sweep"><span style="color: #003399; font-weight: bold;">sweep</span></a><span style="color: #009900;">(</span>trans.mat+<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/rowSums"><span style="color: #003399; font-weight: bold;">rowSums</span></a><span style="color: #009900;">(</span>trans.mat+<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>FUN=<span style="color: blue;">"/"</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><br />I like to visualize my data to make sure everything looks correct. Below is a plot of the transition matrix.&nbsp; The blank space corresponds to non-letter character. A lot of insights can be garnered from this plot. The Q-U relationship pops out. T is the most likely letter to start a word. E is a popular letter to follow many others. Y is likely to end a word.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>melt<span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">)</span><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>Var2<span style="color: #339933;">,</span>Var1<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+geom_tile<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>fill=value<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  scale_fill_gradient<span style="color: #009900;">(</span>low=<span style="color: blue;">"white"</span><span style="color: #339933;">,</span>high=<span style="color: blue;">"black"</span><span style="color: #339933;">,</span>limits=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  labs<span style="color: #009900;">(</span>x=<span style="color: blue;">"Probability of Second Letter"</span><span style="color: #339933;">,</span>y=<span style="color: blue;">"Conditioning on First Letter"</span><span style="color: #339933;">,</span>fill=<span style="color: blue;">"Prob"</span><span style="color: #009900;">)</span>+<br />  scale_y_discrete<span style="color: #009900;">(</span>limits = <a href="http://inside-r.org/r-doc/base/rev"><span style="color: #003399; font-weight: bold;">rev</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/levels"><span style="color: #003399; font-weight: bold;">levels</span></a><span style="color: #009900;">(</span>melt<span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">)</span>$Var1<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  coord_equal<span style="color: #009900;">(</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-rOSjww2Z0q0/UPlrNU1mO2I/AAAAAAAAHqM/NizWxWZ8K88/s1600/trans.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://lh3.ggpht.com/-rOSjww2Z0q0/UPlrNU1mO2I/AAAAAAAAHqM/NizWxWZ8K88/s1600/trans.jpeg" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br />The desired solution will be the one that gives the highest likelihood. This is an <a href="https://en.wikipedia.org/wiki/NP-hard" target="_blank">NP-hard</a> problem so the only way to find the solution is to try all 26! combinations of mappings, which is infeasible, and report the one with the highest likelihood.<br /><br />With the MCMC approach you start with a random mapping of letters. Next you propose a new mapping by randomly switching 2 of the characters in the mapping. So if A mapped to G and L mapped to Z and you switched those two, A would map to Z and L would map to G. With this new mapping, you measure the likelihood and divide it by the likelihood of the previous mapping. If this ratio is greater than 1, then move to this new mapping. If the ratio is less than 1, meaning the new mapping is less likely, then move to this new mapping with a probability equal to the ratio. (Practically, this is done by drawing a random uniform number between 0 and 1 and moving to the proposed mapping if the uniform number is less than the ratio.) Repeat this process until you think you have found a solution.<br /><br />To do this, I first wrote a few functions. One to decode the coded text based on the mapping. The other was to calculate the log likelihood of the decoded text.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">decode &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>coded<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  coded=<a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span>coded<span style="color: #009900;">)</span><br />  decoded=coded<br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>i <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/nchar"><span style="color: #003399; font-weight: bold;">nchar</span></a><span style="color: #009900;">(</span>coded<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>coded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span> %in% <a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      <a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>decoded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">[</span>mapping==<a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>coded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br />  decoded<br /><span style="color: #009900;">}</span><br />&nbsp;<br />&nbsp;<br />log.prob &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>decoded<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  logprob=<span style="color: #cc66cc;">0</span><br />&nbsp;<br />  lastletter=<span style="color: blue;">""</span><br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>i <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/nchar"><span style="color: #003399; font-weight: bold;">nchar</span></a><span style="color: #009900;">(</span>decoded<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    curletter=<a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399; font-weight: bold;">substring</span></a><span style="color: #009900;">(</span>decoded<span style="color: #339933;">,</span>i<span style="color: #339933;">,</span>i<span style="color: #009900;">)</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>curletter %in% <a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      logprob=logprob+<a href="http://inside-r.org/r-doc/base/log"><span style="color: #003399; font-weight: bold;">log</span></a><span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><br />                                         <a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==curletter<span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />      lastletter=curletter<br />    <span style="color: #009900;">}</span> <span style="color: black; font-weight: bold;">else</span> <span style="color: #009900;">{</span><br />      <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />        logprob=logprob+<a href="http://inside-r.org/r-doc/base/log"><span style="color: #003399; font-weight: bold;">log</span></a><span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />        lastletter=<span style="color: blue;">""</span><br />      <span style="color: #009900;">}</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br />&nbsp;<br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>lastletter!=<span style="color: blue;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    logprob=logprob+<a href="http://inside-r.org/r-doc/base/log"><span style="color: #003399; font-weight: bold;">log</span></a><span style="color: #009900;">(</span>trans.prob.mat<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/rownames"><span style="color: #003399; font-weight: bold;">rownames</span></a><span style="color: #009900;">(</span>trans.mat<span style="color: #009900;">)</span>==lastletter<span style="color: #339933;">,</span><span style="color: #cc66cc;">27</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />    lastletter=<span style="color: blue;">""</span><br />  <span style="color: #009900;">}</span><br />  logprob<br /><span style="color: #009900;">}</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br />To show how this works, I will use the same Shakespeare text that is used in the MCMC Revolution paper. I let it run until it tries out 2000 different mappings (not the same as 2000 iterations, because rejected proposals are not counted). Along the way I am keeping track of the most likely mapping visited, and that will be the final estimate. It should be noted that I am only considering the mapping of letters and it is assumed that the special characters are known. For example spaces and periods are assumed to be the same.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">correctTxt=<span style="color: blue;">"ENTER HAMLET HAM TO BE OR NOT TO BE THAT IS THE QUESTION WHETHER TIS NOBLER IN THE MIND TO SUFFER THE SLINGS AND ARROWS OF OUTRAGEOUS FORTUNE OR TO TAKE ARMS AGAINST A SEA OF TROUBLES AND BY OPPOSING END"</span><br />coded=decode<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399; font-weight: bold;">sample</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>correctTxt<span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># randomly scramble the text</span><br />&nbsp;<br />mapping=<a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399; font-weight: bold;">sample</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/toupper"><span style="color: #003399; font-weight: bold;">toupper</span></a><span style="color: #009900;">(</span><span style="color: black; font-weight: bold;">letters</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># initialize a random mapping</span><br />i=<span style="color: #cc66cc;">1</span><br />iters=<span style="color: #cc66cc;">2000</span><br />cur.decode=decode<span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>coded<span style="color: #009900;">)</span><br />cur.loglike=log.prob<span style="color: #009900;">(</span>mapping<span style="color: #339933;">,</span>cur.decode<span style="color: #009900;">)</span><br />max.loglike=cur.loglike<br />max.decode=cur.decode<br /><span style="color: black; font-weight: bold;">while</span> <span style="color: #009900;">(</span>i&lt;=iters<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  proposal=<a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399; font-weight: bold;">sample</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">26</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># select 2 letters to switch</span><br />  prop.mapping=mapping<br />  prop.mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span>=mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><br />  prop.mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span>=mapping<span style="color: #009900;">[</span>proposal<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><br />&nbsp;<br />  prop.decode=decode<span style="color: #009900;">(</span>prop.mapping<span style="color: #339933;">,</span>coded<span style="color: #009900;">)</span><br />  prop.loglike=log.prob<span style="color: #009900;">(</span>prop.mapping<span style="color: #339933;">,</span>prop.decode<span style="color: #009900;">)</span><br />&nbsp;<br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/runif"><span style="color: #003399; font-weight: bold;">runif</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span>&lt;exp<span style="color: #009900;">(</span>prop.loglike-cur.loglike<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    mapping=prop.mapping<br />    cur.decode=prop.decode<br />    cur.loglike=prop.loglike<br />&nbsp;<br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>cur.loglike&gt;max.loglike<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      max.loglike=cur.loglike<br />      max.decode=cur.decode<br />    <span style="color: #009900;">}</span><br />&nbsp;<br />    <a href="http://inside-r.org/r-doc/base/cat"><span style="color: #003399; font-weight: bold;">cat</span></a><span style="color: #009900;">(</span>i<span style="color: #339933;">,</span>cur.decode<span style="color: #339933;">,</span><span style="color: blue;">"<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">)</span><br />    i=i+<span style="color: #cc66cc;">1</span><br />  <span style="color: #009900;">}</span><br /><span style="color: #009900;">}</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br /><br />The output of this example is below. You can see that it comes close but it doesn't quite find the correct mapping. I attribute this to the fact that the text I was trying to decode only had 203 characters. In the paper mentioned above, they decoded the whole play. They further say that their methods work just as well if you randomly sample a text snippet 2000 characters long. Obviously my example had well less than this. This is also a problem in trying to solve a cryptogram because those are even smaller than the Hamlet example I used. So unfortunately this simple method cannot be used for that. (Note that I ran the MCMC chain a several times, using different random starting points, until it came reasonably close to the solution. This is something that the authors also suggested doing.)<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-DABUm0zHOa4/UPmFEVqbsWI/AAAAAAAAHqc/UgIi3nx4VTk/s1600/Iters.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://lh3.ggpht.com/-DABUm0zHOa4/UPmFEVqbsWI/AAAAAAAAHqc/UgIi3nx4VTk/s1600/Iters.png" /></a></div><br /><br />I want to also note that I originally used Alice and Wonderland as the reference text. It had more trouble decoding since this book is much smaller than War and Peace, and therefore the transition probabilities were not as good.<br /><br />The MCMC method is a greedy approach in that you are moving to any mapping that increases the likelihood. Greedy methods are not optimal in general because they can get stuck at local modes, especially in high dimensional problems. MCMC avoids this be moving to less likely mappings with some probability, which ensures that it will find the correct solution with enough time.</div>
<h2>Comments</h2>
<div class="comments">
<div class="comment">
<div class="author">Vivek</div>
<div class="content">
Andrew,<br /><br />This work is cool!<br /><br />I wrote my own substitution cipher decoder using the algorithm described in Stephen Connor&#39;s dissertation as the basis, but I occasionally glanced at your work as well.<br /><br />My code doesn&#39;t work as awesomely as yours, and it is also much slower (possibly because I use 76 versus the 27 characters, reachChar versus readLine), and I use different functions.<br /><br />But I cited your work and copied your idea for the melt matrix, which is ingenious.<br /><br />Thanks so much!<br /><br />Vivek</div>
</div>
<div class="comment">
<div class="author">Andrew Landgraf</div>
<div class="content">
Thanks, Fernando. I knew I could speed it up by treating it as a vector of letters (or integers), but didn&#39;t take the time to figure it out.</div>
</div>
<div class="comment">
<div class="author">Fernando</div>
<div class="content">
Nice work, but the code to get the transition matrix is VERY slow. I manage to make it faster doing the following:<br />1- get the vector of words (using scan() for example).<br />2- For each word, use strsplit(word, NULL)[[1]] and iterate<br />over the characters to populate the matrix.</div>
</div>
<div class="comment">
<div class="author">Andrew</div>
<div class="content">
I have had that issue working on different computers. I think older versions of reshape2 use X# and newer versions use Var#. Or maybe it&#39;s a difference between using the package reshape and reshape2?</div>
</div>
<div class="comment">
<div class="author">Pablik</div>
<div class="content">
Great work! Sometimes I use Persi&#39;s example for teaching MCMC,<br />there are some old matlab code from the original consultancy work,<br />but I never tryed to replicate the example.<br /><br />I got an error at:<br />ggplot(melt(trans.prob.mat),aes(Var2,Var1))+...<br /><br />the melt() function uses X1 and X2:<br />&gt; tmp &lt;- melt(trans.prob.mat)<br />&gt; head(tmp)<br />  X1 X2        value<br />1  A  A 3.893588e-05<br />2  B  A 9.252956e-02<br />...<br />Cheers,<br /><br />Pablo<br /></div>
</div>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Finding the Best Subset of a GAM using Tabu Search and Visualizing It in R]]></title>
    <link href="http://andland.github.io/blog/2012/08/24/finding-best-subset-of-gam-using-tabu/"/>
    <updated>2012-08-24T00:00:00-04:00</updated>
    <id>http://andland.github.io/blog/2012/08/24/finding-best-subset-of-gam-using-tabu</id>
    <content type="html"><![CDATA[<div class="post">
Finding the best subset of variables for a regression is a very common task in statistics and machine learning. There are statistical methods based on asymptotic normal theory that can help you decide whether to add or remove a variable at a time. The problem with this is that it is a greedy approach and you can easily get stuck in a local mode. Another approach is to look at all possible subsets of the variables and see which one maximizes an objective function (accuracy on a test set, for example).<br /><br />Heuristics are required if the number of variables, <i>p</i>, gets large (&gt;40) because the number of possible subsets is equal to 2^<i>p</i>, excluding interactions. One method that works well is called <a href="http://en.wikipedia.org/wiki/Tabu_search">tabu search</a> (TS). It is a more general optimization method, but in the case of finding the best subset, it is similar to stepwise methods. At any point, it will try to improve the objective function the most by adding or removing one variable. One difference is that TS will not add or remove variables that have been recently added or removed. This avoids the optimization from getting stuck at a local maximum. There are more details to the algorithm that you can read up on if you would like.<br /><br />There is a <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">tabuSearch<span style="font-family: Arial,Helvetica,sans-serif;"> </span></span>package in <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">R</span> that implements this algorithm. I wanted to find a best subset regression using generalized additive models (GAMs) of the package <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">mgcv</span>. An issue arose, because you need to specify which terms are smooth and which are not in a formula to use <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">mgcv</span>. The general form of the formula looks like:<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">gam(y ~ s(x1) + s(x2) + x3, data=train)</span><br />where <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">x1</span> and <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">x2</span> are smooth terms and <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">x3</span> is treated like it is in a linear model.<br /><br />My data set has a combination of continuous variables, which I want to treat as smooth, and categorical variables, which I want to treat as factors. For each variable in the subset, I need to identify whether it is a factor or not, and then creating a string of the variable with or without <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">s()</span>. <br /><br />For example, <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">th</span> is a vector of 0's and 1's which indicate whether each variable (column) is in the regression. I used the housing data set from <a href="http://archive.ics.uci.edu/ml/datasets/Housing">UCI ML repository</a>. With 13 explanatory variables, there are 8192 possible main effects models. I am predicting MEDV, so I start the formula string with "MEDV ~". Then I loop through each element of <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">th</span>. If it is 1 then I want to add it to the formula. I check if it is a factor and if so I just add the name of the variable plus a "+". If it is continuous, I add the column name with "<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">s()</span>" around it. Finally I convert the string to a formula using <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">formula()</span>. I can plug in this formula into the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">gam</span> function. <br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;">num.cols=<a href="http://inside-r.org/r-doc/base/sum"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900;">(</span>th<span style="color: #009900;">)</span><br />fo.str=<span style="color: blue;">"MEDV ~"</span><br />cum.cols=<span style="color: #cc66cc;">0</span><br /><span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>i <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/length"><span style="color: #003399; font-weight: bold;">length</span></a><span style="color: #009900;">(</span>th<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>th<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span>&gt;<span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/is.factor"><span style="color: #003399; font-weight: bold;">is.factor</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">[</span><span style="color: #339933;">,</span>i<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      fo.str=<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399; font-weight: bold;">paste</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span><span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">,</span>sep=<span style="color: blue;">" "</span><span style="color: #009900;">)</span><br />    <span style="color: #009900;">}</span> <span style="color: black; font-weight: bold;">else</span> <span style="color: #009900;">{</span><br />      fo.str=<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399; font-weight: bold;">paste</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #339933;">,</span><span style="color: blue;">" s("</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span><span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">,</span><span style="color: blue;">")"</span><span style="color: #339933;">,</span>sep=<span style="color: blue;">""</span><span style="color: #009900;">)</span><br />    <span style="color: #009900;">}</span><br />    cum.cols=cum.cols+<span style="color: #cc66cc;">1</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>cum.cols&lt;num.cols<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      fo.str=<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399; font-weight: bold;">paste</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #339933;">,</span><span style="color: blue;">"+"</span><span style="color: #009900;">)</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br /><span style="color: #009900;">}</span><br />fo=<a href="http://inside-r.org/r-doc/stats/as.formula"><span style="color: #003399; font-weight: bold;">as.formula</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a><br /><br />For evaluating the subsets, I split the data into training, validation, and testing. I trained the subset on the training data set and measured the R-squared on the prediction of the validation set. The full code can be found below.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/mgcv/mgcv"><span style="color: #003399; font-weight: bold;">mgcv</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span>tabuSearch<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># http://archive.ics.uci.edu/ml/datasets/Housing</span><br /><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a>=<a href="http://inside-r.org/r-doc/utils/read.table"><span style="color: #003399; font-weight: bold;">read.table</span></a><span style="color: #009900;">(</span><span style="color: blue;">"http://archive.ics.uci.edu/ml/machine-learning-databases/housing/housing.data"</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a><span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">"CRIM"</span><span style="color: #339933;">,</span> <span style="color: blue;">"ZN"</span><span style="color: #339933;">,</span> <span style="color: blue;">"INDUS"</span><span style="color: #339933;">,</span> <span style="color: blue;">"CHAS"</span><span style="color: #339933;">,</span> <span style="color: blue;">"NOX"</span><span style="color: #339933;">,</span> <span style="color: blue;">"RM"</span><span style="color: #339933;">,</span> <span style="color: blue;">"AGE"</span><span style="color: #339933;">,</span> <span style="color: blue;">"DIS"</span><span style="color: #339933;">,</span> <span style="color: blue;">"RAD"</span><span style="color: #339933;">,</span> <span style="color: blue;">"TAX"</span><span style="color: #339933;">,</span> <span style="color: blue;">"PTRATIO"</span><span style="color: #339933;">,</span> <span style="color: blue;">"B"</span><span style="color: #339933;">,</span> <span style="color: blue;">"LSTAT"</span><span style="color: #339933;">,</span> <span style="color: blue;">"MEDV"</span><span style="color: #009900;">)</span><br />&nbsp;<br /><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a>$CHAS=<a href="http://inside-r.org/r-doc/base/as.factor"><span style="color: #003399; font-weight: bold;">as.factor</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a>$CHAS<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a>$RAD=<a href="http://inside-r.org/r-doc/base/as.factor"><span style="color: #003399; font-weight: bold;">as.factor</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a>$RAD<span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># Changed to factor bc only 9 unique values</span><br /><a href="http://inside-r.org/r-doc/base/summary"><span style="color: #003399; font-weight: bold;">summary</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a><span style="color: #009900;">)</span><br />&nbsp;<br /><a href="http://inside-r.org/r-doc/base/set.seed"><span style="color: #003399; font-weight: bold;">set.seed</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">20120823</span><span style="color: #009900;">)</span><br />cv=<a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399; font-weight: bold;">sample</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/nrow"><span style="color: #003399; font-weight: bold;">nrow</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />train=<a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a><span style="color: #009900;">[</span>cv<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">300</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span><span style="color: #009900;">]</span><br />valid=<a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a><span style="color: #009900;">[</span>cv<span style="color: #009900;">[</span><span style="color: #cc66cc;">301</span>:<span style="color: #cc66cc;">400</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span><span style="color: #009900;">]</span><br />test=<a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a><span style="color: #009900;">[</span>cv<span style="color: #009900;">[</span><span style="color: #cc66cc;">401</span>:<a href="http://inside-r.org/r-doc/base/nrow"><span style="color: #003399; font-weight: bold;">nrow</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/housing"><span style="color: #003399; font-weight: bold;">housing</span></a><span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span><span style="color: #009900;">]</span><br />&nbsp;<br />ssto=<a href="http://inside-r.org/r-doc/base/sum"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900;">(</span><span style="color: #009900;">(</span>valid$MEDV-<a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399; font-weight: bold;">mean</span></a><span style="color: #009900;">(</span>valid$MEDV<span style="color: #009900;">)</span><span style="color: #009900;">)</span>^<span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span><br />evaluate &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>th<span style="color: #009900;">)</span><span style="color: #009900;">{</span> <br />  num.cols=<a href="http://inside-r.org/r-doc/base/sum"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900;">(</span>th<span style="color: #009900;">)</span><br />  <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>num.cols == <span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span> <a href="http://inside-r.org/r-doc/base/return"><span style="color: #003399; font-weight: bold;">return</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span><br />  fo.str=<span style="color: blue;">"MEDV ~"</span><br />  cum.cols=<span style="color: #cc66cc;">0</span><br />  <span style="color: black; font-weight: bold;">for</span> <span style="color: #009900;">(</span>i <span style="color: black; font-weight: bold;">in</span> <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/length"><span style="color: #003399; font-weight: bold;">length</span></a><span style="color: #009900;">(</span>th<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>th<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span>&gt;<span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />      <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/is.factor"><span style="color: #003399; font-weight: bold;">is.factor</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">[</span><span style="color: #339933;">,</span>i<span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />        fo.str=<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399; font-weight: bold;">paste</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span><span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">,</span>sep=<span style="color: blue;">" "</span><span style="color: #009900;">)</span><br />      <span style="color: #009900;">}</span> <span style="color: black; font-weight: bold;">else</span> <span style="color: #009900;">{</span><br />        fo.str=<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399; font-weight: bold;">paste</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #339933;">,</span><span style="color: blue;">" s("</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span><span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">,</span><span style="color: blue;">")"</span><span style="color: #339933;">,</span>sep=<span style="color: blue;">""</span><span style="color: #009900;">)</span><br />      <span style="color: #009900;">}</span><br />      cum.cols=cum.cols+<span style="color: #cc66cc;">1</span><br />      <span style="color: black; font-weight: bold;">if</span> <span style="color: #009900;">(</span>cum.cols&lt;num.cols<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />        fo.str=<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399; font-weight: bold;">paste</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #339933;">,</span><span style="color: blue;">"+"</span><span style="color: #009900;">)</span><br />      <span style="color: #009900;">}</span><br />    <span style="color: #009900;">}</span><br />  <span style="color: #009900;">}</span><br /><span style="color: #666666; font-style: italic;">#   colnames(train)[c(th,0)==1]</span><br />  fo=<a href="http://inside-r.org/r-doc/stats/as.formula"><span style="color: #003399; font-weight: bold;">as.formula</span></a><span style="color: #009900;">(</span>fo.str<span style="color: #009900;">)</span><br />  gam1 &lt;- <a href="http://inside-r.org/r-doc/mgcv/gam"><span style="color: #003399; font-weight: bold;">gam</span></a><span style="color: #009900;">(</span>fo<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a>=train<span style="color: #009900;">)</span><br />  pred1 &lt;- <a href="http://inside-r.org/r-doc/stats/predict"><span style="color: #003399; font-weight: bold;">predict</span></a><span style="color: #009900;">(</span>gam1<span style="color: #339933;">,</span>valid<span style="color: #339933;">,</span>se=<span style="color: black; font-weight: bold;">FALSE</span><span style="color: #009900;">)</span><br />  sse &lt;- <a href="http://inside-r.org/r-doc/base/sum"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900;">(</span><span style="color: #009900;">(</span>pred1-valid$MEDV<span style="color: #009900;">)</span>^<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>na.rm=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span><br />  <a href="http://inside-r.org/r-doc/base/return"><span style="color: #003399; font-weight: bold;">return</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span>-sse/ssto<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br />res &lt;- tabuSearch<span style="color: #009900;">(</span>size = <a href="http://inside-r.org/r-doc/base/ncol"><span style="color: #003399; font-weight: bold;">ncol</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span>-<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> iters = <span style="color: #cc66cc;">20</span><span style="color: #339933;">,</span> objFunc = evaluate<span style="color: #339933;">,</span> listSize = <span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span><br />                  config = <a href="http://inside-r.org/r-doc/stats/rbinom"><span style="color: #003399; font-weight: bold;">rbinom</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/ncol"><span style="color: #003399; font-weight: bold;">ncol</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span>-<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">.5</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> nRestarts = <span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span>verbose=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span></pre></div></div><br />It was able to find a subset with a 0.8678 R-squared on the validation set (and 0.8349 on the test set). The formula found was:<br /><span class="Apple-style-span" style="-webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: #e1e2e5; border-collapse: separate; color: black; font-family: 'Lucida Console'; font-size: 13px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 15px; orphans: 2; text-align: -webkit-left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px;"></span><br /><pre class="GDXA2EVBEAB" style="border-bottom-style: none; border-color: initial; border-left-style: none; border-right-style: none; border-top-style: none; border-width: initial; font-family: 'Lucida Console'; font-size: 10pt !important; line-height: 1.2; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; outline-color: initial; outline-style: none; outline-width: initial; white-space: pre-wrap !important;" tabindex="0">MEDV ~ s(CRIM) + s(INDUS) + s(NOX) + s(RM) + s(DIS) + RAD + s(TAX) + s(PTRATIO) + s(LSTAT).</pre><br /><br /><h3>Visualizing the results</h3>The tabu search gave me a subset which it thinks is best. But I would like to get a better handle on how it derived it, or if there were lots of models with similar quality, but different variables. Or if there were variables that were always in the top performing models. I created a heat plot that showed whether or not a variable was in the regression or not at each iteration.<br /><br />Below you can see which variables were included in each iteration. There are a few variables that seem to be more important because they are included in almost every iteration, like LSAT, PTRATIO,and RM. But this doesn't tell me which iterations were the best.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-h7QkQGRQv7c/UDZm5Lfp40I/AAAAAAAAHKY/EDABwfjZ5R8/s1600/tabu1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-h7QkQGRQv7c/UDZm5Lfp40I/AAAAAAAAHKY/EDABwfjZ5R8/s1600/tabu1.png" /></a></div><br />In the chart below, I shaded each region by the ranking of model in that iteration. The higher ranking mean it did better. It is not easy, but we can glean a little more information from this chart. The models with RAD and DIS do significantly better than the models without them, even though they are not in every iteration. Further, the models with AGE seem a bit worse than those without it.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-TJKQO3ItVkQ/UDZm5o2REyI/AAAAAAAAHKg/UqqyqZ6EELs/s1600/tabu2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-TJKQO3ItVkQ/UDZm5o2REyI/AAAAAAAAHKg/UqqyqZ6EELs/s1600/tabu2.png" /></a></div><br />The R code to make these plots is below.<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/reshape"><span style="color: #003399; font-weight: bold;">reshape</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><span style="color: #339933;">;</span> theme_set<span style="color: #009900;">(</span>theme_bw<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />&nbsp;<br />tabu.df=<a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399; font-weight: bold;">data.frame</span></a><span style="color: #009900;">(</span>res$configKeep<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>tabu.df<span style="color: #009900;">)</span>=<a href="http://inside-r.org/r-doc/base/colnames"><span style="color: #003399; font-weight: bold;">colnames</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/ncol"><span style="color: #003399; font-weight: bold;">ncol</span></a><span style="color: #009900;">(</span>train<span style="color: #009900;">)</span>-<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><br />tabu.df$Iteration=<span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/nrow"><span style="color: #003399; font-weight: bold;">nrow</span></a><span style="color: #009900;">(</span>tabu.df<span style="color: #009900;">)</span><br />tabu.df$RSquared=res$eUtilityKeep<br />tabu.df$Rank=<a href="http://inside-r.org/r-doc/base/rank"><span style="color: #003399; font-weight: bold;">rank</span></a><span style="color: #009900;">(</span>tabu.df$RSquared<span style="color: #009900;">)</span><br />tabu.melt=melt<span style="color: #009900;">(</span>tabu.df<span style="color: #339933;">,</span>id=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">"Iteration"</span><span style="color: #339933;">,</span><span style="color: blue;">"RSquared"</span><span style="color: #339933;">,</span><span style="color: blue;">"Rank"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />tabu.melt$RSquared=<a href="http://inside-r.org/r-doc/base/ifelse"><span style="color: #003399; font-weight: bold;">ifelse</span></a><span style="color: #009900;">(</span>tabu.melt$value==<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span>tabu.melt$RSquared<span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span><br />tabu.melt$Rank=<a href="http://inside-r.org/r-doc/base/ifelse"><span style="color: #003399; font-weight: bold;">ifelse</span></a><span style="color: #009900;">(</span>tabu.melt$value==<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span>tabu.melt$Rank<span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">(</span>pHeat01 &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>tabu.melt<span style="color: #339933;">,</span> aes<span style="color: #009900;">(</span>Iteration<span style="color: #339933;">,</span>variable<span style="color: #009900;">)</span><span style="color: #009900;">)</span> + geom_tile<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>fill = value<span style="color: #009900;">)</span><span style="color: #009900;">)</span> +<br />  scale_fill_gradient<span style="color: #009900;">(</span>low = <span style="color: blue;">"white"</span><span style="color: #339933;">,</span> high = <span style="color: blue;">"steelblue"</span><span style="color: #339933;">,</span>guide=<span style="color: black; font-weight: bold;">FALSE</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">(</span>pHeatRank &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>tabu.melt<span style="color: #339933;">,</span> aes<span style="color: #009900;">(</span>Iteration<span style="color: #339933;">,</span>variable<span style="color: #009900;">)</span><span style="color: #009900;">)</span> + geom_tile<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>fill = Rank<span style="color: #009900;">)</span><span style="color: #009900;">)</span> +<br />  scale_fill_gradient<span style="color: #009900;">(</span>low = <span style="color: blue;">"white"</span><span style="color: #339933;">,</span> high = <span style="color: blue;">"steelblue"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></pre></div></div><a href="http://www.inside-r.org/pretty-r" title="Created by Pretty R at inside-R.org">Created by Pretty R at inside-R.org</a></div>
<h2>Comments</h2>
<div class="comments">
<div class="comment">
<div class="author">anonymous</div>
<div class="content">
Good post!<br /><br />Nice approach with the heat map to go beyond just accepting the optimal solution. I agree that variables seem to be important because they are present in every iteration, but this could perhaps also mean that the tabu search was trapped in a subregion - perhaps the search move operator which only adds or deletes a single variable is not powerful enough to escape this region. Some possible remedies for exploring a larger part of the search landscape (if indeed this is a problem) might be:<br /><br />- Multiple tabu searches, each with a randomized set of initial variables in the model<br />- Other move operators. How about finding correlation clusters among the variables, then let a move add or delete the entire cluster? Both move operators can be used in the search, using some metaheuristics to guide them.<br />- Use metaheuristic techniques like &quot;ruin and recreate&quot; during the tabu search; occasionally, &quot;ruin&quot; the model by removing a random subset of the variables.<br /><br />One more thought. With the tabu search already in place for regression, it wouldnt be too hard to explore some nonlinear models. You could create temp variables that are products of the original variables, then let the tabu search add or delete these as well. Do you think such an approach would have any merit in this case?<br /></div>
</div>
<div class="comment">
<div class="author">Andrew</div>
<div class="content">
@Anonymous I would also like to see how this does compared to the more standard methods. It will take a little effort to implement in this example, though, because these variable selection techniques are not implemented for GAMs (as far as I know). http://www.statmethods.net/stats/regression.html has a nice summary of different methods available for linear models. You are right that the whole point of using a TS is that it will be better than the other methods, so it would be good to have validation. Maybe I could do a comparison for linear models...<br /><br />I described the meat of the TS algorithm in the post. If you want more info, I found this reference informative http://www.math.ntua.gr/~fouskakis/Publications/4.pdf </div>
</div>
<div class="comment">
<div class="author">Andrew</div>
<div class="content">
@anspiess That is probably a good idea. But one reason to use Tabu Search is that it will speed up the time to find the best model. Running it many times will defeat this purpose. Running time for the parameters used was long already because GAMs take longer to train than LMs (~ 9 mins). In terms of better understanding TS, your idea would be useful. For what its worth, I ran it again with a different CV split and the chosen model was the same except it added s(ZN) and removed s(PTRATIO).</div>
</div>
<div class="comment">
<div class="author">anspiess</div>
<div class="content">
Might it be feasible to sample training and test set a few hundred times to see how stable variable selection is?</div>
</div>
<div class="comment">
<div class="author">Anonymous</div>
<div class="content">
I wonder how this method is better than using F test, t test or information criterion? did you compare tabusearch to other methods (for linear models)? maybe it its faster than standard methods? I would be grateful for answers:)  if it its possible maybe you can describe this algorithm more closely.</div>
</div>
</div>
]]></content>
  </entry>
  
</feed>
